<!DOCTYPE html>
<!-- saved from url=(0073)https://romgrk.com/posts/optimizing-javascript#1-avoid-string-comparisons -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!-- Global Metadata --><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="https://romgrk.com/favicon.svg"><link rel="alternate" type="application/rss+xml" title="RSS" href="https://romgrk.com/rss.xml"><meta name="generator" content="Astro v3.1.2"><!-- External --><link rel="stylesheet" href="./Optimizing Javascript for fun and for profit_files/font-awesome.min.css" crossorigin=""><!-- Canonical URL --><link rel="canonical" href="https://romgrk.com/posts/optimizing-javascript"><!-- Primary Meta Tags --><title>Optimizing Javascript for fun and for profit</title><meta name="title" content="Optimizing Javascript for fun and for profit"><meta name="description" content="romgrk&#39;s personal blog"><!-- Cloudflare Web Analytics --><script defer="" src="./Optimizing Javascript for fun and for profit_files/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;b0171e625c244ce483071d0333f87a2e&quot;}"></script><!-- End Cloudflare Web Analytics --><!-- Open Graph / Facebook --><!-- <meta property="og:type" content="website" /> --><!-- <meta property="og:url" content={Astro.url} /> --><!-- <meta property="og:title" content={title} /> --><!-- <meta property="og:description" content={description} /> --><!-- <meta property="og:image" content={new URL(image, Astro.url)} /> --><!-- Twitter --><!-- <meta property="twitter:card" content="summary_large_image" /> --><!-- <meta property="twitter:url" content={Astro.url} /> --><!-- <meta property="twitter:title" content={title} /> --><!-- <meta property="twitter:description" content={description} /> --><!-- <meta property="twitter:image" content={new URL(image, Astro.url)} /> --><link rel="stylesheet" href="./Optimizing Javascript for fun and for profit_files/castle.918bf1e1.css">
<style>.post[data-astro-cid-xj2uyz6m]{display:flex;flex-direction:row}.post-padding[data-astro-cid-xj2uyz6m]{width:var(--padding-width)}.post-content[data-astro-cid-xj2uyz6m]{width:var(--content-width)}.post-sidebar[data-astro-cid-xj2uyz6m]{width:var(--padding-width)}.post-header[data-astro-cid-xj2uyz6m]{text-align:center;line-height:1;margin-bottom:2em}.post-title[data-astro-cid-xj2uyz6m]{font-size:2rem;margin-bottom:2rem}.post-date[data-astro-cid-xj2uyz6m]{color:var(--color-muted-2x-fg);font-size:1.1rem;margin-bottom:1em}.post-sidebar-content[data-astro-cid-xj2uyz6m]{display:none;position:sticky;top:2rem;padding-right:1rem;overflow:hidden}@media (min-width: 1400px){.post-sidebar[data-astro-cid-xj2uyz6m]{padding-top:18rem;display:flex;flex-direction:row;justify-content:flex-end;align-items:flex-start;padding-left:1rem}.post-sidebar-content[data-astro-cid-xj2uyz6m]{display:block!important}}.post-sidebar-content[data-astro-cid-xj2uyz6m] a[data-astro-cid-xj2uyz6m]{display:block;white-space:nowrap;padding-left:2rem;padding-right:1rem;border-top-right-radius:.25rem;border-bottom-right-radius:.25rem;--tw-text-opacity: 1;color:rgb(229 229 229 / var(--tw-text-opacity));border-left-width:1px;--tw-border-opacity: 1;border-color:rgb(64 64 64 / var(--tw-border-opacity))}.post-sidebar-content[data-astro-cid-xj2uyz6m] a[data-astro-cid-xj2uyz6m]:hover{background-color:#7373731a}.post-sidebar-content[data-astro-cid-xj2uyz6m] a[data-astro-cid-xj2uyz6m].active{border-left-width:1px;--tw-border-opacity: 1;border-color:rgb(96 165 250 / var(--tw-border-opacity));background-color:#60a5fa1a}
</style><style>.aside{padding:1rem;border-radius:.5rem;border-width:1px;--tw-border-opacity: 1;border-color:rgb(115 115 115 / var(--tw-border-opacity));background-color:#d4d4d40d;margin-bottom:2rem}.aside h6{font-size:.8em;display:flex;flex-direction:row;align-items:center;--tw-text-opacity: 1;color:rgb(163 163 163 / var(--tw-text-opacity))}.aside svg{margin-right:.5rem}.aside.aside p,.aside.aside pre{margin-bottom:0rem}.aside p:last-child,.aside pre:last-child{margin:0}.aside-small{font-size:.875rem;line-height:1.25rem;line-height:1.4}.aside-small svg{margin-right:.5rem}.aside-small h6{font-size:1em}
</style><style>.random-plant{display:flex;justify-content:center;align-items:center}.random-plant-svg,.random-plant-svg>svg,.then{display:inline-block;height:100px}
</style></head><body><header class="header" data-astro-cid-3ef6ksr2=""><a class="header-title" href="https://romgrk.com/" data-astro-cid-3ef6ksr2=""><span class="inline md:hidden" data-astro-cid-3ef6ksr2="">R</span><span class="hidden md:inline" data-astro-cid-3ef6ksr2="">romgrk</span></a><div class="header-links" data-astro-cid-3ef6ksr2=""><a href="https://romgrk.com/posts" data-astro-cid-3ef6ksr2="">Posts</a><a href="https://romgrk.com/castle" data-astro-cid-3ef6ksr2="">The Castle<span class="hidden md:inline" data-astro-cid-3ef6ksr2="">, by H. Wenng</span></a></div><div class="header-fill" data-astro-cid-3ef6ksr2=""></div><a class="header-github" href="https://github.com/romgrk" target="_blank" data-astro-cid-3ef6ksr2=""><span class="fa fa-github" data-astro-cid-3ef6ksr2=""></span><span class="sr-only" data-astro-cid-3ef6ksr2="">Github</span></a></header><main class="no-padding"><script>(function(){const DISPLAY = true;
const MAX_DEPTH = 2;


document.addEventListener('DOMContentLoaded', () => {
  if (!DISPLAY) return

  const html = document.querySelector('html')
  const sidebar = document.querySelector('.post-sidebar')
  const headings =
    Array.from(document.querySelector('.post-body')
      .querySelectorAll(
        Array.from({ length: MAX_DEPTH }).map((_, i) => `h${i + 1}`).join(', ')))

  const sidebarLinkFor = id => document.querySelector(`[href="#${id}"]`)

  document.addEventListener('scroll', () => {
    const active =
      headings.reduce((active, h) => {
        if ((html.scrollTop + html.clientHeight / 2) > h.offsetTop)
          return h
        return active
      })

    const current = sidebar.querySelector('.active')
    const isMatching = current?.href.slice(1) === active?.id

    if (current && !isMatching) {
      current.classList.remove('active')
    }
    if (active && !isMatching) {
      sidebarLinkFor(active.id).classList.add('active')
    }
  })
})
})();</script><article class="post" data-astro-cid-xj2uyz6m=""><div class="post-padding" data-astro-cid-xj2uyz6m=""></div><div class="post-content" data-astro-cid-xj2uyz6m=""><div class="post-header" data-astro-cid-xj2uyz6m=""><div class="post-date" data-astro-cid-xj2uyz6m=""><time datetime="2024-03-21T00:00:00.000Z">21 March 2024</time></div><h1 class="post-title" data-astro-cid-xj2uyz6m="">Optimizing Javascript for fun and for profit</h1><hr data-astro-cid-xj2uyz6m=""></div><div class="post-body markdown-content" data-astro-cid-xj2uyz6m=""><!-- <CONTENT> --><p>I often feel like javascript code in general runs much slower than it could, simply because it’s not optimized properly. Here is a summary of common optimization techniques I’ve found useful. Note that the tradeoff for performance is often readability, so the question of when to go for performance versus readability is a question left to the reader. I’ll also note that talking about optimization necessarily requires talking about benchmarking. Micro-optimizing a function for hours to have it run 100x faster is meaningless if the function only represented a fraction of the actual overall runtime to start with. If one is optimizing, the first and most important step is benchmarking. I’ll cover the topic in the later points. Be also aware that micro-benchmarks are often flawed, and that may include those presented here. I’ve done my best to avoid those traps, but don’t blindly apply any of the points presented here without benchmarking.</p>
<p>I have included runnable examples for all cases where it’s possible. They show by default the results I got on my machine (brave 122 on archlinux) but you can run them yourself. As much as I hate to say it, Firefox has fallen a bit behind in the optimization game, and represents a very small fraction of the traffic <a href="https://foundation.mozilla.org/en/?form=donate-header">for now</a>, so I don’t recommend using the results you’d get on Firefox as useful indicators.</p>
<h2 id="0-avoid-work">0. Avoid work</h2>
<p>This might sound evident, but it needs to be here because there can’t be another first step to optimization: if you’re trying to optimize, you should first look into avoiding work. This includes concepts like memoization, laziness and incremental computation. This would be applied differently depending on the context. In React, for example, that would mean applying <code>memo()</code>, <code>useMemo()</code> and other applicable primitives.</p>
<h2 id="1-avoid-string-comparisons">1. Avoid string comparisons</h2>
<p>Javascript makes it easy to hide the real cost of string comparisons. If you need to compare strings in C, you’d use the <code>strcmp(a, b)</code> function. Javascript uses <code>===</code> instead, so you don’t see the <code>strcmp</code>. But it’s there, and a string comparison will usually (but not always) require comparing each of the characters in the string with the ones in the other string; string comparison is <code>O(n)</code>. One common JavaScript pattern to avoid is strings-as-enums. But with the advent of TypeScript this should be easily avoidable, as
enums are integers by default.</p>
<div class="code-blocks-row"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="typescript" data-theme="github-dark-dimmed"><code data-language="typescript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// No</span></span>
<span data-line=""><span style="color:#F47067">enum</span><span style="color:#F69D50"> Position</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#6CB6FF">  TOP</span><span style="color:#F47067">    =</span><span style="color:#96D0FF"> 'TOP'</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#6CB6FF">  BOTTOM</span><span style="color:#F47067"> =</span><span style="color:#96D0FF"> 'BOTTOM'</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="typescript" data-theme="github-dark-dimmed"><code data-language="typescript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// Yeppers</span></span>
<span data-line=""><span style="color:#F47067">enum</span><span style="color:#F69D50"> Position</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#6CB6FF">  TOP</span><span style="color:#ADBAC7">,    </span><span style="color:#768390">// = 0</span></span>
<span data-line=""><span style="color:#6CB6FF">  BOTTOM</span><span style="color:#ADBAC7">, </span><span style="color:#768390">// = 1</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure></div>
<p>Here is a comparison of the costs:</p>
<div id="benchmark-compare" class="code-blocks-row"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 1. string compare</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> Position</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#ADBAC7">  TOP: </span><span style="color:#96D0FF">'TOP'</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">  BOTTOM: </span><span style="color:#96D0FF">'BOTTOM'</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> _ </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span></span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#6CB6FF"> 1000000</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#F47067">  let</span><span style="color:#ADBAC7"> current </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">%</span><span style="color:#6CB6FF"> 2</span><span style="color:#F47067"> ===</span><span style="color:#6CB6FF"> 0</span><span style="color:#F47067"> ?</span></span>
<span data-line=""><span style="color:#ADBAC7">    Position.</span><span style="color:#6CB6FF">TOP</span><span style="color:#F47067"> :</span><span style="color:#ADBAC7"> Position.</span><span style="color:#6CB6FF">BOTTOM</span></span>
<span data-line=""><span style="color:#F47067">  if</span><span style="color:#ADBAC7"> (current </span><span style="color:#F47067">===</span><span style="color:#ADBAC7"> Position.</span><span style="color:#6CB6FF">TOP</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">    _ </span><span style="color:#F47067">+=</span><span style="color:#6CB6FF"> 1</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 2. int compare</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> Position</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#ADBAC7">  TOP: </span><span style="color:#6CB6FF">0</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">  BOTTOM: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> _ </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span></span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#6CB6FF"> 1000000</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#F47067">  let</span><span style="color:#ADBAC7"> current </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">%</span><span style="color:#6CB6FF"> 2</span><span style="color:#F47067"> ===</span><span style="color:#6CB6FF"> 0</span><span style="color:#F47067"> ?</span></span>
<span data-line=""><span style="color:#ADBAC7">    Position.</span><span style="color:#6CB6FF">TOP</span><span style="color:#F47067"> :</span><span style="color:#ADBAC7"> Position.</span><span style="color:#6CB6FF">BOTTOM</span></span>
<span data-line=""><span style="color:#F47067">  if</span><span style="color:#ADBAC7"> (current </span><span style="color:#F47067">===</span><span style="color:#ADBAC7"> Position.</span><span style="color:#6CB6FF">TOP</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">    _ </span><span style="color:#F47067">+=</span><span style="color:#6CB6FF"> 1</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure></div>
<style style="display:none">astro-island,astro-slot,astro-static-slot{display:contents}</style><script style="display:none">(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();;(()=>{var b=Object.defineProperty;var f=(a,s,i)=>s in a?b(a,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):a[s]=i;var d=(a,s,i)=>(f(a,typeof s!="symbol"?s+"":s,i),i);var u;{let a={0:t=>m(t),1:t=>i(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(i(t)),5:t=>new Set(i(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},s=t=>{let[e,r]=t;return e in a?a[e](r):void 0},i=t=>t.map(s),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,r])=>[e,s(r)]));customElements.get("astro-island")||customElements.define("astro-island",(u=class extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var l;if(!this.hydrator||!this.isConnected)return;let e=(l=this.parentElement)==null?void 0:l.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let r=this.querySelectorAll("astro-slot"),c={},h=this.querySelectorAll("template[data-astro-template]");for(let n of h){let o=n.closest(this.tagName);o!=null&&o.isSameNode(this)&&(c[n.getAttribute("data-astro-template")||"default"]=n.innerHTML,n.remove())}for(let n of r){let o=n.closest(this.tagName);o!=null&&o.isSameNode(this)&&(c[n.getAttribute("name")||"default"]=n.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(n){let o=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(o+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${o}`,this.getAttribute("props"),n),n}await this.hydrator(this)(this.Component,p,c,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){!this.hasAttribute("await-children")||this.firstChild?this.childrenConnectedCallback():new MutationObserver((e,r)=>{r.disconnect(),setTimeout(()=>this.childrenConnectedCallback(),0)}).observe(this,{childList:!0})}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),r=this.getAttribute("client");if(Astro[r]===void 0){window.addEventListener(`astro:${r}`,()=>this.start(),{once:!0});return}Astro[r](async()=>{let c=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),c?import(c):()=>()=>{}]),l=this.getAttribute("component-export")||"default";if(!l.includes("."))this.Component=h[l];else{this.Component=h;for(let n of l.split("."))this.Component=this.Component[n]}return this.hydrator=p,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},d(u,"observedAttributes",["props"]),u))}})();</script><astro-island uid="1g2lMQ" prefix="r0" component-url="/_astro/Benchmark.848f928f.js" component-export="default" renderer-url="/_astro/client.06fbcffe.js" props="{&quot;selector&quot;:[0,&quot;#benchmark-compare&quot;],&quot;results&quot;:[0,{&quot;1. string compare&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,828],&quot;percent&quot;:[0,50.35]}],&quot;2. int compare&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,2137],&quot;percent&quot;:[0,100]}]}]}" client="load" opts="{&quot;name&quot;:&quot;Benchmark&quot;,&quot;value&quot;:true}" await-children=""><div class="flex md:flex-row flex-col gap-4 mb-2"><div class="flex-1 mb-1 grid grid-cols-[max-content_auto]"><div class="w-max-content pr-4"><b class="text-sm">1. string compare:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">2. int compare:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div></div><div><button class="w-20">Show</button></div></div></astro-island>
<aside class="aside aside-info  aside-small"><h6><svg width="1em" height="1em" viewBox="0 0 16 16" data-icon="octicon:info-16"><symbol id="ai:octicon:info-16"><path fill="currentColor" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-6.5a6.5 6.5 0 1 0 0 13a6.5 6.5 0 0 0 0-13M6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75M8 6a1 1 0 1 1 0-2a1 1 0 0 1 0 2"></path></symbol><use xlink:href="#ai:octicon:info-16"></use></svg><span>About benchmarks</span></h6><p>Percentage results represent the number of operations completed within 1s, divided by the number of operations of the highest scoring case. Higher is better.</p></aside>
<p>As you can see, the difference can be significant. The difference isn’t necessarily due to the <code>strcmp</code> cost as engines can sometimes use a string pool and compare by reference, but it’s also due to the fact that integers are usually passed by value in JS engines, whereas strings are always passed as pointers, and memory accesses are expensive (see section 5). In string-heavy code, this can have a huge impact.</p>
<p>For a real-world example, I was able to <a href="https://github.com/json5/json5/pull/278">make this JSON5 javascript parser run 2x faster</a>* just by replacing string constants with numbers.<br>
<small>*Unfortunately it wasn’t merged, but that’s how open-source is.</small></p>
<h2 id="2-avoid-different-shapes">2. Avoid different shapes</h2>
<p>Javascript engines try to optimize code by assuming that objects have a specific shape, and that functions will receive objects of the same shape. This allows them to store the keys of the shape once for all objects of that shape, and the values in a separate flat array. To represent it in javascript:</p>
<div class="code-blocks-row"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> objects</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> [</span></span>
<span data-line=""><span style="color:#ADBAC7">  {</span></span>
<span data-line=""><span style="color:#ADBAC7">    name: </span><span style="color:#96D0FF">'Anthony'</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">    age: </span><span style="color:#6CB6FF">36</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">  },</span></span>
<span data-line=""><span style="color:#ADBAC7">  {</span></span>
<span data-line=""><span style="color:#ADBAC7">    name: </span><span style="color:#96D0FF">'Eckhart'</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">    age: </span><span style="color:#6CB6FF">42</span></span>
<span data-line=""><span style="color:#ADBAC7">  },</span></span>
<span data-line=""><span style="color:#ADBAC7">]</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> shape</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> [</span></span>
<span data-line=""><span style="color:#ADBAC7">  { name: </span><span style="color:#96D0FF">'name'</span><span style="color:#ADBAC7">, type: </span><span style="color:#96D0FF">'string'</span><span style="color:#ADBAC7"> },</span></span>
<span data-line=""><span style="color:#ADBAC7">  { name: </span><span style="color:#96D0FF">'age'</span><span style="color:#ADBAC7">,  type: </span><span style="color:#96D0FF">'integer'</span><span style="color:#ADBAC7"> },</span></span>
<span data-line=""><span style="color:#ADBAC7">]</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> objects</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> [</span></span>
<span data-line=""><span style="color:#ADBAC7">  [</span><span style="color:#96D0FF">'Anthony'</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">36</span><span style="color:#ADBAC7">],</span></span>
<span data-line=""><span style="color:#ADBAC7">  [</span><span style="color:#96D0FF">'Eckhart'</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">42</span><span style="color:#ADBAC7">],</span></span>
<span data-line=""><span style="color:#ADBAC7">]</span></span>
<span data-line=""> </span></code></pre></figure></div>
<aside class="aside aside-info "><h6><svg width="1em" height="1em" viewBox="0 0 16 16" data-icon="octicon:info-16"><use xlink:href="#ai:octicon:info-16"></use></svg><span>A note on terminology</span></h6><p>I have used the word “shape” for this concept, but be aware that you may also find <em>“hidden class”</em> or <em>“map”</em> used to describe it, depending on the engine.</p></aside>
<p>For example, at runtime if the following function receives two objects with the shape <code>{ x: number, y: number }</code>, the engine is going to speculate that future objects will have the same shape, and generate machine code optimized for that shape.</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#F47067">function</span><span style="color:#DCBDFB"> add</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">a</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">b</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#F47067">  return</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#ADBAC7">    x: a.x </span><span style="color:#F47067">+</span><span style="color:#ADBAC7"> b.x,</span></span>
<span data-line=""><span style="color:#ADBAC7">    y: a.y </span><span style="color:#F47067">+</span><span style="color:#ADBAC7"> b.y,</span></span>
<span data-line=""><span style="color:#ADBAC7">  }</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure>
<p>If one would instead pass an object not with the shape <code>{ x, y }</code> but with the shape <code>{ y, x }</code>, the engine would need to undo its speculation and the function would suddenly become considerably slower. I’m going to limit my explanation here because you should read  the <a href="https://mrale.ph/blog/2015/01/11/whats-up-with-monomorphism.html">excellent post from mraleph</a> if you want more details, but I’m going to highlight that V8 in particular has 3 modes, for accesses that are: monomorphic (1 shape), polymorphic (2-4 shapes), and megamorphic (5+ shapes). Let’s say you <em>really</em> want to stay monomorphic, because the slowdown is drastic:</p>
<div id="benchmark-shape" class="code-blocks"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// setup</span></span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> _ </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 1. monomorphic</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o1</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">, b: _, c: _, d: _, e: _ }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o2</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">, b: _, c: _, d: _, e: _ }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o3</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">, b: _, c: _, d: _, e: _ }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o4</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">, b: _, c: _, d: _, e: _ }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o5</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">, b: _, c: _, d: _, e: _ } </span><span style="color:#768390">// all shapes are equal</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 2. polymorphic</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o1</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">, b: _, c: _, d: _, e: _ }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o2</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">, b: _, c: _, d: _, e: _ }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o3</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">, b: _, c: _, d: _, e: _ }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o4</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">, b: _, c: _, d: _, e: _ }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o5</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { b: _, a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">, c: _, d: _, e: _ } </span><span style="color:#768390">// this shape is different</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 3. megamorphic</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o1</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">, b: _, c: _, d: _, e: _ }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o2</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { b: _, a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">, c: _, d: _, e: _ }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o3</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { b: _, c: _, a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">, d: _, e: _ }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o4</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { b: _, c: _, d: _, a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">, e: _ }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> o5</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { b: _, c: _, d: _, e: _, a: </span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7"> } </span><span style="color:#768390">// all shapes are different</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// test case</span></span>
<span data-line=""><span style="color:#F47067">function</span><span style="color:#DCBDFB"> add</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">a1</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">b1</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#F47067">  return</span><span style="color:#ADBAC7"> a1.a </span><span style="color:#F47067">+</span><span style="color:#ADBAC7"> a1.b </span><span style="color:#F47067">+</span><span style="color:#ADBAC7"> a1.c </span><span style="color:#F47067">+</span><span style="color:#ADBAC7"> a1.d </span><span style="color:#F47067">+</span><span style="color:#ADBAC7"> a1.e </span><span style="color:#F47067">+</span></span>
<span data-line=""><span style="color:#ADBAC7">         b1.a </span><span style="color:#F47067">+</span><span style="color:#ADBAC7"> b1.b </span><span style="color:#F47067">+</span><span style="color:#ADBAC7"> b1.c </span><span style="color:#F47067">+</span><span style="color:#ADBAC7"> b1.d </span><span style="color:#F47067">+</span><span style="color:#ADBAC7"> b1.e }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> result </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span></span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#6CB6FF"> 1000000</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#ADBAC7">  result </span><span style="color:#F47067">+=</span><span style="color:#DCBDFB"> add</span><span style="color:#ADBAC7">(o1, o2)</span></span>
<span data-line=""><span style="color:#ADBAC7">  result </span><span style="color:#F47067">+=</span><span style="color:#DCBDFB"> add</span><span style="color:#ADBAC7">(o3, o4)</span></span>
<span data-line=""><span style="color:#ADBAC7">  result </span><span style="color:#F47067">+=</span><span style="color:#DCBDFB"> add</span><span style="color:#ADBAC7">(o4, o5)</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure></div>
<astro-island uid="Z1zsznU" prefix="r1" component-url="/_astro/Benchmark.848f928f.js" component-export="default" renderer-url="/_astro/client.06fbcffe.js" props="{&quot;selector&quot;:[0,&quot;#benchmark-shape&quot;],&quot;results&quot;:[0,{&quot;1. monomorphic&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,1247],&quot;percent&quot;:[0,100]}],&quot;2. polymorphic&quot;:[0,{&quot;runTime&quot;:[0,-1003],&quot;amountOfRounds&quot;:[0,163],&quot;percent&quot;:[0,13.07]}],&quot;3. megamorphic&quot;:[0,{&quot;runTime&quot;:[0,-1008],&quot;amountOfRounds&quot;:[0,51],&quot;percent&quot;:[0,4.09]}]}]}" client="load" opts="{&quot;name&quot;:&quot;Benchmark&quot;,&quot;value&quot;:true}" await-children=""><div class="flex md:flex-row flex-col gap-4 mb-2"><div class="flex-1 mb-1 grid grid-cols-[max-content_auto]"><div class="w-max-content pr-4"><b class="text-sm">1. monomorphic:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">2. polymorphic:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">3. megamorphic:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div></div><div><button class="w-20">Show</button></div></div></astro-island>
<h4 id="what-the-eff-should-i-do-about-this">What the eff should I do about this?</h4>
<p>Easier said than done but: <strong>create all your objects with the exact same shape</strong>. Even something as trivial as <strong>writing your React component props in a different order can trigger this</strong>.</p>
<p>For example, here are <a href="https://github.com/facebook/react/pull/28569">simple cases</a> I found in React’s codebase, but they already had a <a href="https://v8.dev/blog/react-cliff">much higher impact case</a> of the same problem a few years ago because they were initializing an object with an integer, then later storing a float. Yes, changing the type also changes the shape. Yes, there are integer and float types hidden behind <code>number</code>. Deal with it.</p>
<aside class="aside aside-info "><h6><svg width="1em" height="1em" viewBox="0 0 16 16" data-icon="octicon:info-16"><use xlink:href="#ai:octicon:info-16"></use></svg><span>Number representation</span></h6><p>Engines can usually encode integers as values. For example, V8 represents values in 32 bits, with integers as compact <a href="https://medium.com/fhinkel/v8-internals-how-small-is-a-small-integer-e0badc18b6da">Smi</a> (SMall Integer) values, but floats and large integers are passed as pointers just like strings and objects. JSC uses a 64 bit encoding, <a href="https://ktln2.org/2020/08/25/javascriptcore/">double tagging</a>, to pass all numbers by value, as SpiderMonkey does, and the rest is passed as pointers.</p></aside>
<h2 id="3-avoid-arrayobject-methods">3. Avoid array/object methods</h2>
<p>I love functional programming as much as anyone else, but unless you’re working in Haskell/OCaml/Rust where functional code gets compiled to efficient machine code, functional will always be slower than imperative.</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> result</span><span style="color:#F47067"> =</span></span>
<span data-line=""><span style="color:#ADBAC7">  [</span><span style="color:#6CB6FF">1.5</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">3.5</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">5.0</span><span style="color:#ADBAC7">]</span></span>
<span data-line=""><span style="color:#ADBAC7">    .</span><span style="color:#DCBDFB">map</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">n</span><span style="color:#F47067"> =&gt;</span><span style="color:#ADBAC7"> Math.</span><span style="color:#DCBDFB">round</span><span style="color:#ADBAC7">(n))</span></span>
<span data-line=""><span style="color:#ADBAC7">    .</span><span style="color:#DCBDFB">filter</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">n</span><span style="color:#F47067"> =&gt;</span><span style="color:#ADBAC7"> n </span><span style="color:#F47067">%</span><span style="color:#6CB6FF"> 2</span><span style="color:#F47067"> ===</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">    .</span><span style="color:#DCBDFB">reduce</span><span style="color:#ADBAC7">((</span><span style="color:#F69D50">a</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">n</span><span style="color:#ADBAC7">) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> a </span><span style="color:#F47067">+</span><span style="color:#ADBAC7"> n, </span><span style="color:#6CB6FF">0</span><span style="color:#ADBAC7">)</span></span></code></pre></figure>
<p>The problem with those methods is that:</p>
<ol>
<li>They need to make a full copy of the array, and those copies later need to be freed by the garbage collector.  We will explore more in details the issues of memory I/O in section 5.</li>
<li>They loop N times for N operations, whereas a <code>for</code> loop would allow looping once.</li>
</ol>
<div id="benchmark-array-methods" class="code-blocks"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// setup:</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> numbers</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> Array.</span><span style="color:#DCBDFB">from</span><span style="color:#ADBAC7">({ length: </span><span style="color:#6CB6FF">10_000</span><span style="color:#ADBAC7"> }).</span><span style="color:#DCBDFB">map</span><span style="color:#ADBAC7">(() </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> Math.</span><span style="color:#DCBDFB">random</span><span style="color:#ADBAC7">())</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 1. functional</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> result</span><span style="color:#F47067"> =</span></span>
<span data-line=""><span style="color:#ADBAC7">  numbers</span></span>
<span data-line=""><span style="color:#ADBAC7">    .</span><span style="color:#DCBDFB">map</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">n</span><span style="color:#F47067"> =&gt;</span><span style="color:#ADBAC7"> Math.</span><span style="color:#DCBDFB">round</span><span style="color:#ADBAC7">(n </span><span style="color:#F47067">*</span><span style="color:#6CB6FF"> 10</span><span style="color:#ADBAC7">))</span></span>
<span data-line=""><span style="color:#ADBAC7">    .</span><span style="color:#DCBDFB">filter</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">n</span><span style="color:#F47067"> =&gt;</span><span style="color:#ADBAC7"> n </span><span style="color:#F47067">%</span><span style="color:#6CB6FF"> 2</span><span style="color:#F47067"> ===</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">    .</span><span style="color:#DCBDFB">reduce</span><span style="color:#ADBAC7">((</span><span style="color:#F69D50">a</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">n</span><span style="color:#ADBAC7">) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> a </span><span style="color:#F47067">+</span><span style="color:#ADBAC7"> n, </span><span style="color:#6CB6FF">0</span><span style="color:#ADBAC7">)</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 2. imperative</span></span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> result </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span></span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#ADBAC7"> numbers.</span><span style="color:#6CB6FF">length</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#F47067">  let</span><span style="color:#ADBAC7"> n </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> Math.</span><span style="color:#DCBDFB">round</span><span style="color:#ADBAC7">(numbers[i] </span><span style="color:#F47067">*</span><span style="color:#6CB6FF"> 10</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#F47067">  if</span><span style="color:#ADBAC7"> (n </span><span style="color:#F47067">%</span><span style="color:#6CB6FF"> 2</span><span style="color:#F47067"> !==</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">) </span><span style="color:#F47067">continue</span></span>
<span data-line=""><span style="color:#ADBAC7">  result </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> result </span><span style="color:#F47067">+</span><span style="color:#ADBAC7"> n</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure></div>
<astro-island uid="ZHAQl4" prefix="r2" component-url="/_astro/Benchmark.848f928f.js" component-export="default" renderer-url="/_astro/client.06fbcffe.js" props="{&quot;selector&quot;:[0,&quot;#benchmark-array-methods&quot;],&quot;results&quot;:[0,{&quot;1. functional&quot;:[0,{&quot;runTime&quot;:[0,-1002],&quot;amountOfRounds&quot;:[0,303],&quot;percent&quot;:[0,36.51]}],&quot;2. imperative&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,830],&quot;percent&quot;:[0,100]}]}]}" client="load" opts="{&quot;name&quot;:&quot;Benchmark&quot;,&quot;value&quot;:true}" await-children=""><div class="flex md:flex-row flex-col gap-4 mb-2"><div class="flex-1 mb-1 grid grid-cols-[max-content_auto]"><div class="w-max-content pr-4"><b class="text-sm">1. functional:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">2. imperative:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div></div><div><button class="w-20">Show</button></div></div></astro-island>
<br>
<p>Object methods such as <code>Object.values()</code>, <code>Object.keys()</code> and <code>Object.entries()</code> suffer from similar problems, as they also allocate more data, and memory accesses are the root of all performance issues. No really I swear, I’ll show you in section 5.</p>
<h2 id="4-avoid-indirection">4. Avoid indirection</h2>
<p>Another place to look for optimization gains is any source of indirection, of which I can see 3 main sources:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> point</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { x: </span><span style="color:#6CB6FF">10</span><span style="color:#ADBAC7">, y: </span><span style="color:#6CB6FF">20</span><span style="color:#ADBAC7"> }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#768390">// 1.</span></span>
<span data-line=""><span style="color:#768390">// Proxy objects are harder to optimize because their get/set function might</span></span>
<span data-line=""><span style="color:#768390">// be running custom logic, so engines can't make their usual assumptions.</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> proxy</span><span style="color:#F47067"> =</span><span style="color:#F47067"> new</span><span style="color:#DCBDFB"> Proxy</span><span style="color:#ADBAC7">(point, { </span><span style="color:#DCBDFB">get</span><span style="color:#ADBAC7">: (</span><span style="color:#F69D50">t</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">k</span><span style="color:#ADBAC7">) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> { </span><span style="color:#F47067">return</span><span style="color:#ADBAC7"> t[k] } })</span></span>
<span data-line=""><span style="color:#768390">// Some engines can make proxy costs disappear, but those optimizations are</span></span>
<span data-line=""><span style="color:#768390">// expensive to make and can break easily.</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> x</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> proxy.x</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#768390">// 2.</span></span>
<span data-line=""><span style="color:#768390">// Usually ignored, but accessing an object via `.` or `[]` is also an</span></span>
<span data-line=""><span style="color:#768390">// indirection. In easy cases, the engine may very well be able to optimize the</span></span>
<span data-line=""><span style="color:#768390">// cost away:</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> x</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> point.x</span></span>
<span data-line=""><span style="color:#768390">// But each additional access multiplies the cost, and makes it harder for the</span></span>
<span data-line=""><span style="color:#768390">// engine to make assumptions about the state of `point`:</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> x</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> this</span><span style="color:#ADBAC7">.state.circle.center.point.x</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#768390">// 3.</span></span>
<span data-line=""><span style="color:#768390">// And finally, function calls can also have a cost. Engine are generally good</span></span>
<span data-line=""><span style="color:#768390">// at inlining these:</span></span>
<span data-line=""><span style="color:#F47067">function</span><span style="color:#DCBDFB"> getX</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">p</span><span style="color:#ADBAC7">) { </span><span style="color:#F47067">return</span><span style="color:#ADBAC7"> p.x }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> x</span><span style="color:#F47067"> =</span><span style="color:#DCBDFB"> getX</span><span style="color:#ADBAC7">(p)</span></span>
<span data-line=""><span style="color:#768390">// But it's not guaranteed that they can. In particular if the function call</span></span>
<span data-line=""><span style="color:#768390">// isn't from a static function but comes from e.g. an argument:</span></span>
<span data-line=""><span style="color:#F47067">function</span><span style="color:#DCBDFB"> Component</span><span style="color:#ADBAC7">({ </span><span style="color:#F69D50">point</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">getX</span><span style="color:#ADBAC7"> }) {</span></span>
<span data-line=""><span style="color:#F47067">  return</span><span style="color:#DCBDFB"> getX</span><span style="color:#ADBAC7">(point)</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure>
<p>The proxy benchmark is particularly brutal on V8 at the moment. Last time I checked, proxy objects were always falling back from the JIT to the interpreter, seeing from those results it might still be the case.</p>
<div id="benchmark-proxy" class="code-blocks"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 1. proxy access</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> point</span><span style="color:#F47067"> =</span><span style="color:#F47067"> new</span><span style="color:#DCBDFB"> Proxy</span><span style="color:#ADBAC7">({ x: </span><span style="color:#6CB6FF">10</span><span style="color:#ADBAC7">, y: </span><span style="color:#6CB6FF">20</span><span style="color:#ADBAC7"> }, { </span><span style="color:#DCBDFB">get</span><span style="color:#ADBAC7">: (</span><span style="color:#F69D50">t</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">k</span><span style="color:#ADBAC7">) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> t[k] })</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> _ </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">, i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#6CB6FF"> 100_000</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) { _ </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> point.x }</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 2. direct access</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> point</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { x: </span><span style="color:#6CB6FF">10</span><span style="color:#ADBAC7">, y: </span><span style="color:#6CB6FF">20</span><span style="color:#ADBAC7"> }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> x</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> point.x</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> _ </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">, i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#6CB6FF"> 100_000</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) { _ </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> x }</span></span></code></pre></figure></div>
<astro-island uid="lFKSK" prefix="r3" component-url="/_astro/Benchmark.848f928f.js" component-export="default" renderer-url="/_astro/client.06fbcffe.js" props="{&quot;selector&quot;:[0,&quot;#benchmark-proxy&quot;],&quot;results&quot;:[0,{&quot;1. proxy access&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,659],&quot;percent&quot;:[0,2.8]}],&quot;2. direct access&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,23544],&quot;percent&quot;:[0,100]}]}]}" client="load" opts="{&quot;name&quot;:&quot;Benchmark&quot;,&quot;value&quot;:true}" await-children=""><div class="flex md:flex-row flex-col gap-4 mb-2"><div class="flex-1 mb-1 grid grid-cols-[max-content_auto]"><div class="w-max-content pr-4"><b class="text-sm">1. proxy access:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">2. direct access:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div></div><div><button class="w-20">Show</button></div></div></astro-island>
<div id="benchmark-object" class="code-blocks"><p>I also wanted to showcase accessing a deeply nested object vs direct access, but engines are very good at <a href="https://youtu.be/KiWEWLwQ3oI?t=1055">optimizing away object accesses via escape analysis</a> when there is a hot loop and a constant object. I inserted a bit of indirection to prevent it.</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 1. nested access</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> a</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { state: { center: { point: { x: </span><span style="color:#6CB6FF">10</span><span style="color:#ADBAC7">, y: </span><span style="color:#6CB6FF">20</span><span style="color:#ADBAC7"> } } } }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> b</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { state: { center: { point: { x: </span><span style="color:#6CB6FF">10</span><span style="color:#ADBAC7">, y: </span><span style="color:#6CB6FF">20</span><span style="color:#ADBAC7"> } } } }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#DCBDFB"> get</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> (</span><span style="color:#F69D50">i</span><span style="color:#ADBAC7">) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">%</span><span style="color:#6CB6FF"> 2</span><span style="color:#F47067"> ?</span><span style="color:#ADBAC7"> a </span><span style="color:#F47067">:</span><span style="color:#ADBAC7"> b</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> result </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span></span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#6CB6FF"> 100_000</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#ADBAC7">  result </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> result </span><span style="color:#F47067">+</span><span style="color:#DCBDFB"> get</span><span style="color:#ADBAC7">(i).state.center.point.x }</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 2. direct access</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> a</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { x: </span><span style="color:#6CB6FF">10</span><span style="color:#ADBAC7">, y: </span><span style="color:#6CB6FF">20</span><span style="color:#ADBAC7"> }.x</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> b</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { x: </span><span style="color:#6CB6FF">10</span><span style="color:#ADBAC7">, y: </span><span style="color:#6CB6FF">20</span><span style="color:#ADBAC7"> }.x</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#DCBDFB"> get</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> (</span><span style="color:#F69D50">i</span><span style="color:#ADBAC7">) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">%</span><span style="color:#6CB6FF"> 2</span><span style="color:#F47067"> ?</span><span style="color:#ADBAC7"> a </span><span style="color:#F47067">:</span><span style="color:#ADBAC7"> b</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> result </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span></span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#6CB6FF"> 100_000</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#ADBAC7">  result </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> result </span><span style="color:#F47067">+</span><span style="color:#DCBDFB"> get</span><span style="color:#ADBAC7">(i) }</span></span></code></pre></figure></div>
<astro-island uid="Zqoh8R" prefix="r4" component-url="/_astro/Benchmark.848f928f.js" component-export="default" renderer-url="/_astro/client.06fbcffe.js" props="{&quot;selector&quot;:[0,&quot;#benchmark-object&quot;],&quot;results&quot;:[0,{&quot;1. nested access&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,9871],&quot;percent&quot;:[0,42.08]}],&quot;2. direct access&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,23460],&quot;percent&quot;:[0,100]}]}]}" client="load" opts="{&quot;name&quot;:&quot;Benchmark&quot;,&quot;value&quot;:true}" await-children=""><div class="flex md:flex-row flex-col gap-4 mb-2"><div class="flex-1 mb-1 grid grid-cols-[max-content_auto]"><div class="w-max-content pr-4"><b class="text-sm">1. nested access:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">2. direct access:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div></div><div><button class="w-20">Show</button></div></div></astro-island>
<h2 id="5-avoid-cache-misses">5. Avoid cache misses</h2>
<p>This point requires a bit of low-level knowledge, but has implications even in javascript, so I’ll explain. From the CPU point of view, retrieving memory from RAM is slow. To speed things up, it uses mainly two optimizations.</p>
<h3 id="51-prefetching">5.1 Prefetching</h3>
<p>The first one is prefetching: it fetches more memory ahead of time, in the hope that it’s the memory you’ll be interested in. It always guesses that if you request one memory address, you’ll be interested in the memory region that comes right after that. So <strong>accessing data sequentially</strong> is the key. In the following example, we can observe the impact of accessing memory in random order.</p>
<div id="benchmark-prefetch" class="code-blocks"><div class="hidden"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// setup:</span></span>
<span data-line=""><span style="color:#F47067">function</span><span style="color:#DCBDFB"> shuffle</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">array</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#F47067">  let</span><span style="color:#ADBAC7"> currentIndex </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> array.</span><span style="color:#6CB6FF">length</span><span style="color:#ADBAC7">,  randomIndex;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">  while</span><span style="color:#ADBAC7"> (currentIndex </span><span style="color:#F47067">&gt;</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#ADBAC7">    randomIndex </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> Math.</span><span style="color:#DCBDFB">floor</span><span style="color:#ADBAC7">(Math.</span><span style="color:#DCBDFB">random</span><span style="color:#ADBAC7">() </span><span style="color:#F47067">*</span><span style="color:#ADBAC7"> currentIndex);</span></span>
<span data-line=""><span style="color:#ADBAC7">    currentIndex</span><span style="color:#F47067">--</span><span style="color:#ADBAC7">;</span></span>
<span data-line=""><span style="color:#ADBAC7">    [array[currentIndex], array[randomIndex]] </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> [</span></span>
<span data-line=""><span style="color:#ADBAC7">      array[randomIndex], array[currentIndex]];</span></span>
<span data-line=""><span style="color:#ADBAC7">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">  return</span><span style="color:#ADBAC7"> array;</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure></div><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// setup:</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> K</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> 1024</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> length</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> 1</span><span style="color:#F47067"> *</span><span style="color:#6CB6FF"> K</span><span style="color:#F47067"> *</span><span style="color:#6CB6FF"> K</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#768390">// Theses points are created one after the other, so they are allocated</span></span>
<span data-line=""><span style="color:#768390">// sequentially in memory.</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> points</span><span style="color:#F47067"> =</span><span style="color:#F47067"> new</span><span style="color:#DCBDFB"> Array</span><span style="color:#ADBAC7">(length)</span></span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#ADBAC7"> points.</span><span style="color:#6CB6FF">length</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#ADBAC7">  points[i] </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> { x: </span><span style="color:#6CB6FF">42</span><span style="color:#ADBAC7">, y: </span><span style="color:#6CB6FF">0</span><span style="color:#ADBAC7"> }</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#768390">// This array contains the *same data* as above, but shuffled randomly.</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> shuffledPoints</span><span style="color:#F47067"> =</span><span style="color:#DCBDFB"> shuffle</span><span style="color:#ADBAC7">(points.</span><span style="color:#DCBDFB">slice</span><span style="color:#ADBAC7">())</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 1. sequential</span></span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> _ </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span></span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#ADBAC7"> points.</span><span style="color:#6CB6FF">length</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) { _ </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> points[i].x }</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 2. random</span></span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> _ </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span></span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#ADBAC7"> shuffledPoints.</span><span style="color:#6CB6FF">length</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) { _ </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> shuffledPoints[i].x }</span></span></code></pre></figure></div>
<astro-island uid="Z1kUb15" prefix="r5" component-url="/_astro/Benchmark.848f928f.js" component-export="default" renderer-url="/_astro/client.06fbcffe.js" props="{&quot;selector&quot;:[0,&quot;#benchmark-prefetch&quot;],&quot;results&quot;:[0,{&quot;2. random&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,226],&quot;percent&quot;:[0,26.22]}],&quot;1. sequential&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,862],&quot;percent&quot;:[0,100]}]}]}" client="load" opts="{&quot;name&quot;:&quot;Benchmark&quot;,&quot;value&quot;:true}" await-children=""><div class="flex md:flex-row flex-col gap-4 mb-2"><div class="flex-1 mb-1 grid grid-cols-[max-content_auto]"><div class="w-max-content pr-4"><b class="text-sm">1. sequential:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">2. random:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div></div><div><button class="w-20">Show</button></div></div></astro-island>
<h4 id="what-the-eff-should-i-do-about-this-1">What the eff should I do about this?</h4>
<p>This aspect is probably the hardest to put in practice, because javascript doesn’t have a way of placing objects in memory, but you can use that knowledge to your advantage as in the example above, for example to operate on data before re-ordering or sorting it. You cannot assume that objects created sequentially will stay at the same location after some time because the garbage collector might move them around. There is one exception to that, and it’s arrays of numbers, preferably <code>TypedArray</code> instances:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// from this</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> points</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> [{ x: </span><span style="color:#6CB6FF">0</span><span style="color:#ADBAC7">, y: </span><span style="color:#6CB6FF">5</span><span style="color:#ADBAC7"> }, { x: </span><span style="color:#6CB6FF">0</span><span style="color:#ADBAC7">, y: </span><span style="color:#6CB6FF">10</span><span style="color:#ADBAC7"> }]</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#768390">// to this</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> points</span><span style="color:#F47067"> =</span><span style="color:#F47067"> new</span><span style="color:#DCBDFB"> Int64Array</span><span style="color:#ADBAC7">([</span><span style="color:#6CB6FF">0</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">5</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">0</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">10</span><span style="color:#ADBAC7">])</span></span></code></pre></figure>
<p>For a more detailed example, <a href="https://mrale.ph/blog/2018/02/03/maybe-you-dont-need-rust-to-speed-up-your-js.html#optimizing-parsing---reducing-gc-pressure">see this link</a>* .<br>
<small>*Note that it contains some optimizations that are now outdated, but it’s still accurate overall.</small></p>
<h3 id="52-caching-in-l123">5.2 Caching in L1/2/3</h3>
<p>The second optimization CPUs use is the L1/L2/L3 caches: those are like faster RAMs, but they are also more expensive, so they are much smaller. They contain RAM data, but act as an LRU cache. Data comes in while it’s “hot” (being worked on), and is written back to the main RAM when new working data needs the space. So the key here is <strong>use as little data as possible to keep your working dataset in the fast caches</strong>. In the following example, we can observe what are the effects of busting each of the successive caches.</p>
<div id="benchmark-caches" class="code-blocks"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// setup:</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> KB</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> 1024</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> MB</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> 1024</span><span style="color:#F47067"> *</span><span style="color:#6CB6FF"> KB</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#768390">// These are approximate sizes to fit in those caches. If you don't get the</span></span>
<span data-line=""><span style="color:#768390">// same results on your machine, it might be because your sizes differ.</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> L1</span><span style="color:#F47067">  =</span><span style="color:#6CB6FF"> 256</span><span style="color:#F47067"> *</span><span style="color:#6CB6FF"> KB</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> L2</span><span style="color:#F47067">  =</span><span style="color:#6CB6FF">   5</span><span style="color:#F47067"> *</span><span style="color:#6CB6FF"> MB</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> L3</span><span style="color:#F47067">  =</span><span style="color:#6CB6FF">  18</span><span style="color:#F47067"> *</span><span style="color:#6CB6FF"> MB</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> RAM</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF">  32</span><span style="color:#F47067"> *</span><span style="color:#6CB6FF"> MB</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#768390">// We'll be accessing the same buffer for all test cases, but we'll</span></span>
<span data-line=""><span style="color:#768390">// only be accessing the first 0 to `L1` entries in the first case,</span></span>
<span data-line=""><span style="color:#768390">// 0 to `L2` in the second, etc.</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> buffer</span><span style="color:#F47067"> =</span><span style="color:#F47067"> new</span><span style="color:#DCBDFB"> Int8Array</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">RAM</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">buffer.</span><span style="color:#DCBDFB">fill</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">42</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#DCBDFB"> random</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> (</span><span style="color:#F69D50">max</span><span style="color:#ADBAC7">) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> Math.</span><span style="color:#DCBDFB">floor</span><span style="color:#ADBAC7">(Math.</span><span style="color:#DCBDFB">random</span><span style="color:#ADBAC7">() </span><span style="color:#F47067">*</span><span style="color:#ADBAC7"> max)</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 1. L1</span></span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> r </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; </span><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#6CB6FF"> 100000</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) { r </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> buffer[</span><span style="color:#DCBDFB">random</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">L1</span><span style="color:#ADBAC7">)] }</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 2. L2</span></span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> r </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; </span><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#6CB6FF"> 100000</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) { r </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> buffer[</span><span style="color:#DCBDFB">random</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">L2</span><span style="color:#ADBAC7">)] }</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 3. L3</span></span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> r </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; </span><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#6CB6FF"> 100000</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) { r </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> buffer[</span><span style="color:#DCBDFB">random</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">L3</span><span style="color:#ADBAC7">)] }</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 4. RAM</span></span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> r </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; </span><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#6CB6FF"> 100000</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) { r </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> buffer[</span><span style="color:#DCBDFB">random</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">RAM</span><span style="color:#ADBAC7">)] }</span></span></code></pre></figure></div>
<astro-island uid="Z2lrKDu" prefix="r6" component-url="/_astro/Benchmark.848f928f.js" component-export="default" renderer-url="/_astro/client.06fbcffe.js" props="{&quot;selector&quot;:[0,&quot;#benchmark-caches&quot;],&quot;results&quot;:[0,{&quot;1. L1&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,1800],&quot;percent&quot;:[0,100]}],&quot;2. L2&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,1405],&quot;percent&quot;:[0,78.06]}],&quot;3. L3&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,1186],&quot;percent&quot;:[0,65.89]}],&quot;4. RAM&quot;:[0,{&quot;runTime&quot;:[0,-1002],&quot;amountOfRounds&quot;:[0,528],&quot;percent&quot;:[0,29.33]}]}]}" client="load" opts="{&quot;name&quot;:&quot;Benchmark&quot;,&quot;value&quot;:true}" await-children=""><div class="flex md:flex-row flex-col gap-4 mb-2"><div class="flex-1 mb-1 grid grid-cols-[max-content_auto]"><div class="w-max-content pr-4"><b class="text-sm">1. L1:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">2. L2:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">3. L3:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">4. RAM:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div></div><div><button class="w-20">Show</button></div></div></astro-island>
<h4 id="what-the-eff-should-i-do-about-this-2">What the eff should I do about this?</h4>
<p><strong>Ruthlessly eliminate every single data or memory allocations</strong> that can be eliminated. The smaller your dataset is, the faster your program will run. Memory I/O is the bottleneck for 95% of programs. Another good strategy can be to split your work into chunks, and ensure you work on a small dataset at a time.</p>
<p>For more details on CPU and memory, <a href="https://people.freebsd.org/~lstewart/articles/cpumemory.pdf">see this link</a>.</p>
<aside class="aside aside-info "><h6><svg width="1em" height="1em" viewBox="0 0 16 16" data-icon="octicon:info-16"><use xlink:href="#ai:octicon:info-16"></use></svg><span>About immutable data structures</span></h6><p>Immutability is great for clarity and correctness, but in the context of performance, updating an immutable data structure means making a copy of the container, and that’s more memory I/O that will flush your caches. You should avoid immutable data structures when possible.</p></aside>
<aside class="aside aside-info "><h6><svg width="1em" height="1em" viewBox="0 0 16 16" data-icon="octicon:info-16"><use xlink:href="#ai:octicon:info-16"></use></svg><span>About the { ...spread } operator </span></h6><p>It’s very convenient, but every time you use it you create a new object in memory. More memory I/O, slower caches!</p></aside>
<br>
<div class="random-plant"><div class="random-plant-svg "><!--?xml version="1.0" encoding="utf-8"?-->
<svg viewBox="120.252 310.289 129.641 226.433" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <clippath clipPathUnits="userSpaceOnUse" id="clipPath20">
      <path d="M 0,500 H 750 V 0 H 0 Z" id="path18"></path>
    </clippath>
    <clippath clipPathUnits="userSpaceOnUse" id="clipPath952">
      <path d="m 127.158,187.434 h 38.934 v -44.2 h -38.934 z" id="path950"></path>
    </clippath>
    <clippath clipPathUnits="userSpaceOnUse" id="clipPath976">
      <path d="m 141.202,223.736 h 51.365 v -62.865 h -51.365 z" id="path974"></path>
    </clippath>
    <clippath clipPathUnits="userSpaceOnUse" id="clipPath1000">
      <path d="m 159.658,175.314 h 30.378 v -35.431 h -30.378 z" id="path998"></path>
    </clippath>
    <clippath clipPathUnits="userSpaceOnUse" id="clipPath1024">
      <path d="m 138.939,125.727 h 72.085 V 69.0254 h -72.085 z" id="path1022"></path>
    </clippath>
  </defs>
  <g id="g8" transform="matrix(1.3333332538604736, 0, 0, -1.3333332538604736, 0, 666.6666870117188)">
    <g id="g14">
      <g id="g16" clip-path="url(#clipPath20)" transform="matrix(1, 0, 0, 1, -23.605152, 28.433477)">
        <g id="g942" transform="translate(167.4219,169.3613)">
          <path d="m 0,0 c -6.334,-2.256 0.209,2.738 1.259,6.039 1.049,3.299 -3.036,9.135 -5.817,8.32 -2.782,-0.814 -6.121,-5.838 -8.212,-4.447 -3.428,2.279 1.524,4.688 2.11,8.057 0.589,3.365 -4.717,5.484 -6.987,3.236 -2.269,-2.25 -3.373,-4.096 -5.064,-3.156 -1.694,0.943 0.833,3.121 0.989,5.441 0.158,2.321 -12.563,5.242 -16.717,4.809 -3.228,-2.649 -10.03,-13.903 -8.269,-15.418 1.762,-1.52 5.565,-1.235 5.043,-3.1 -0.521,-1.867 -3.088,-1.373 -6.282,-1.406 -3.194,-0.035 -5.417,-5.295 -2.611,-7.246 2.808,-1.947 7.787,-0.389 7.139,-4.219 -0.591,-3.488 -6.326,-1.252 -8.86,-2.656 -2.534,-1.406 -1.256,-8.414 1.829,-9.984 3.085,-1.577 13.507,1.492 7.326,-3.012 -5.435,-3.959 -10.675,-1.424 -4.78,-9.106 5.897,-7.679 29.439,1.543 29.439,1.543 l 4.758,2.164 c 0,0 24.059,10.438 21.794,19.85 C 6.377,2.816 3.871,1.379 0,0" style="fill:#84980d;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path944"></path>
        </g>
        <g id="g946">
          <g id="g948"></g>
          <g id="g960">
            <g clip-path="url(#clipPath952)" opacity="0.100006" id="g958">
              <g transform="translate(160.5181,156.3594)" id="g956">
                <path d="m 0,0 c 8.353,4.334 7.468,8.887 -3.667,4.336 -8.794,-3.596 -3.21,2.303 0.799,7.537 4.012,5.236 -1.04,6.672 -7.594,3.598 -6.555,-3.073 -6.32,-2.278 -2.901,4.662 4.876,9.896 0.374,9.494 -4.406,3.857 -4.78,-5.638 -4.582,5.281 -7.715,6.871 -3.134,1.59 -1.268,-6.144 0.22,-9.593 1.489,-3.448 -5.445,-1.543 -7.164,-4.206 -1.72,-2.669 9.302,-1.576 11.001,-5.482 1.698,-3.904 -8.39,-4.74 -11.304,-6.732 -2.913,-1.994 4.864,-4.289 11.459,-3.748 6.593,0.541 7.634,-4.717 0.083,-6.805 -7.552,-2.086 -8.392,-6.983 0.222,-5.104 4.982,1.088 8.028,-0.367 9.791,-2.316 l 4.373,1.986 c 0,0 0.747,0.332 1.955,0.926 C -5.24,-6.803 -4.653,-2.418 0,0" style="fill:#414042;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path954"></path>
              </g>
            </g>
          </g>
        </g>
        <g id="g962" transform="translate(161.2373,160.1582)">
          <path d="m 0,0 c -0.037,0.061 -0.553,-0.162 -1.493,-0.637 -0.933,-0.494 -2.331,-1.168 -4,-2.209 -0.842,-0.515 -1.773,-1.08 -2.79,-1.701 -0.896,-0.588 -1.866,-1.226 -2.887,-1.904 -1.413,3.513 -2.808,6.814 -4.17,9.851 2.705,1.993 4.977,3.573 6.628,4.702 1.973,1.312 3.048,2.084 2.988,2.185 -0.036,0.065 -0.552,-0.162 -1.493,-0.637 -0.932,-0.49 -2.33,-1.164 -4,-2.207 -0.842,-0.513 -1.773,-1.08 -2.789,-1.697 -0.58,-0.383 -1.204,-0.795 -1.842,-1.215 -0.294,0.653 -0.584,1.301 -0.868,1.926 -0.347,0.732 -0.689,1.447 -1.02,2.143 -0.538,1.117 -1.042,2.171 -1.555,3.179 1.491,2.983 2.781,5.399 3.734,7.145 1.16,2.066 1.765,3.244 1.664,3.306 -0.062,0.041 -0.418,-0.392 -1.04,-1.242 -0.605,-0.865 -1.544,-2.103 -2.556,-3.791 -0.515,-0.84 -1.086,-1.767 -1.711,-2.779 -0.242,-0.426 -0.495,-0.875 -0.755,-1.334 -0.522,1.008 -1.024,1.973 -1.485,2.861 -0.588,1.032 -1.127,1.979 -1.612,2.838 -0.951,1.723 -1.846,2.992 -2.42,3.877 -0.59,0.871 -0.931,1.319 -0.994,1.281 -0.101,-0.06 0.46,-1.257 1.545,-3.365 0.933,-1.863 2.207,-4.467 3.673,-7.699 -1.128,0.086 -2.173,0.164 -3.114,0.236 -1.96,0.17 -3.513,0.137 -4.569,0.155 -1.052,-0.004 -1.614,-0.039 -1.618,-0.112 -0.006,-0.119 1.301,-0.32 3.656,-0.593 1.598,-0.208 3.701,-0.495 6.183,-0.885 0.03,-0.065 0.058,-0.125 0.087,-0.194 0.867,-1.939 1.766,-4.088 2.736,-6.394 0.23,-0.58 0.468,-1.168 0.708,-1.764 -0.634,-0.178 -1.256,-0.353 -1.836,-0.515 -1.134,-0.366 -2.173,-0.7 -3.111,-0.999 -1.88,-0.578 -3.308,-1.191 -4.291,-1.574 -0.975,-0.4 -1.481,-0.642 -1.458,-0.711 0.037,-0.113 1.326,0.19 3.61,0.823 1.866,0.494 4.421,1.14 7.538,1.849 0.588,-1.463 1.186,-2.972 1.774,-4.553 0.694,-1.802 1.394,-3.679 2.097,-5.613 -1.264,-0.418 -2.457,-0.816 -3.554,-1.181 -1.115,-0.415 -2.137,-0.797 -3.062,-1.141 -1.849,-0.672 -3.244,-1.35 -4.208,-1.779 -0.954,-0.446 -1.452,-0.711 -1.423,-0.776 0.042,-0.115 1.315,0.252 3.566,0.99 2.164,0.684 5.269,1.627 9.123,2.666 1.206,-3.343 2.418,-6.849 3.63,-10.478 3.632,-10.795 7.195,-22.637 10.466,-34.238 0.992,0.486 2.075,0.806 3.182,0.968 -1.045,3.45 -2.122,6.915 -3.224,10.368 -3.912,12.328 -8.176,24.464 -12.32,34.89 3.18,2.371 5.826,4.217 7.691,5.49 C -1.015,-0.877 0.06,-0.104 0,0" style="fill:#42602f;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path964"></path>
        </g>
        <g id="g966" transform="translate(135.582,189.002)">
          <path d="m 0,0 c 9.038,-0.834 -1.188,3.514 -3.664,7.479 -2.476,3.964 0.92,12.958 4.829,12.824 3.909,-0.135 9.955,-5.588 12.226,-3.074 3.721,4.126 -3.558,5.623 -5.452,9.83 -1.892,4.207 4.339,8.748 8.058,6.566 3.718,-2.184 5.779,-4.229 7.678,-2.436 1.9,1.799 -2.131,3.805 -3.112,6.788 -0.98,2.98 14.68,11.052 20.258,11.871 5.108,-2.387 17.76,-14.828 15.963,-17.403 -1.797,-2.574 -6.867,-3.474 -5.561,-5.74 1.306,-2.266 4.499,-0.764 8.686,0.262 4.188,1.021 8.854,-5.119 5.834,-8.606 -3.023,-3.484 -10.054,-3.105 -7.926,-7.9 1.936,-4.363 8.689,0.475 12.474,-0.516 3.785,-0.992 4.453,-10.584 0.941,-13.67 -3.508,-3.086 -18.162,-2.556 -8.576,-6.384 8.432,-3.364 14.439,1.701 9.294,-10.311 -5.146,-12.016 -39.017,-7.812 -39.017,-7.812 l -6.944,1.24 c 0,0 -34.952,5.615 -35.134,18.683 C -9.281,1.555 -5.523,0.514 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path968"></path>
        </g>
        <g id="g970">
          <g id="g972"></g>
          <g id="g984">
            <g clip-path="url(#clipPath976)" opacity="0.100006" id="g982">
              <g transform="translate(150.2285,174.3027)" id="g980">
                <path d="m 0,0 c -12.374,2.881 -12.735,9.131 3.348,6.898 12.703,-1.765 3.428,4.082 -3.565,9.59 -6.993,5.506 -0.865,9.074 8.733,7.242 9.597,-1.828 9.025,-0.869 2.236,7.063 -9.681,11.312 -3.66,12.293 4.475,6.516 8.134,-5.774 4.228,8.441 7.794,11.564 C 26.59,52 26.732,41.262 25.937,36.254 25.141,31.248 33.574,36.057 36.713,33.145 39.852,30.229 25.072,27.979 24.156,22.301 23.239,16.627 36.712,18.906 41.187,17.27 45.662,15.637 36.258,10.035 27.453,8.543 c -8.804,-1.492 -8.409,-8.717 2.162,-8.926 10.573,-0.205 13.307,-6.33 1.414,-6.75 -6.878,-0.242 -10.376,-3.16 -12.03,-6.299 l -6.381,1.139 c 0,0 -1.09,0.184 -2.865,0.557 C 9.125,-7.145 6.893,-1.604 0,0" style="fill:#414042;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path978"></path>
              </g>
            </g>
          </g>
        </g>
        <g id="g986" transform="translate(148.02,179.0312)">
          <path d="m 0,0 c 0.026,0.094 0.776,-0.025 2.164,-0.334 1.384,-0.332 3.44,-0.748 5.969,-1.553 1.273,-0.388 2.68,-0.82 4.217,-1.289 1.366,-0.47 2.85,-0.984 4.412,-1.529 0.673,5.068 1.396,9.85 2.164,14.275 -4.204,1.705 -7.701,3.012 -10.239,3.938 -3.02,1.055 -4.683,1.707 -4.638,1.859 0.027,0.096 0.777,-0.025 2.164,-0.332 1.385,-0.334 3.439,-0.75 5.97,-1.553 1.272,-0.39 2.68,-0.82 4.215,-1.291 0.887,-0.304 1.838,-0.634 2.813,-0.972 0.166,0.955 0.33,1.898 0.493,2.81 0.211,1.073 0.419,2.123 0.618,3.145 0.331,1.637 0.637,3.187 0.971,4.678 -2.943,3.398 -5.439,6.128 -7.268,8.095 -2.208,2.315 -3.393,3.653 -3.281,3.77 0.066,0.072 0.678,-0.375 1.774,-1.281 1.081,-0.928 2.723,-2.233 4.609,-4.1 0.955,-0.928 2.012,-1.951 3.166,-3.066 0.458,-0.477 0.941,-0.981 1.433,-1.493 0.347,1.494 0.682,2.918 0.989,4.235 0.423,1.547 0.811,2.97 1.159,4.256 0.668,2.568 1.414,4.529 1.868,5.878 0.482,1.334 0.779,2.034 0.873,2.006 0.154,-0.045 -0.18,-1.8 -0.897,-4.918 -0.596,-2.748 -1.394,-6.578 -2.231,-11.297 1.448,0.489 2.787,0.94 3.994,1.35 2.505,0.879 4.549,1.354 5.922,1.727 1.379,0.347 2.124,0.492 2.154,0.396 0.049,-0.154 -1.595,-0.851 -4.582,-2 -2.022,-0.801 -4.675,-1.879 -7.792,-3.221 -0.016,-0.093 -0.032,-0.183 -0.049,-0.277 -0.486,-2.83 -0.942,-5.941 -1.442,-9.283 -0.109,-0.832 -0.222,-1.68 -0.337,-2.541 0.889,-0.024 1.761,-0.041 2.575,-0.063 C 25.533,9.928 27.003,9.84 28.333,9.762 30.983,9.631 33.055,9.307 34.468,9.135 35.875,8.938 36.62,8.789 36.612,8.691 36.601,8.533 34.814,8.5 31.616,8.563 29.014,8.584 25.453,8.578 21.14,8.465 20.86,6.355 20.581,4.178 20.34,1.914 c -0.304,-2.588 -0.593,-5.275 -0.867,-8.039 1.793,-0.125 3.485,-0.244 5.041,-0.355 1.597,-0.174 3.063,-0.332 4.385,-0.473 2.643,-0.258 4.696,-0.68 6.099,-0.918 1.396,-0.266 2.135,-0.447 2.12,-0.543 -0.017,-0.162 -1.804,-0.107 -4.995,0.107 -3.058,0.17 -7.434,0.37 -12.821,0.44 -0.46,-4.776 -0.875,-9.768 -1.249,-14.92 -1.143,-15.328 -1.848,-32.004 -2.251,-48.27 -1.462,0.305 -2.987,0.364 -4.486,0.205 0.215,4.856 0.465,9.75 0.753,14.635 1.001,17.43 2.522,34.725 4.461,49.744 -4.949,2.039 -9.028,3.569 -11.892,4.61 C 1.618,-0.805 -0.045,-0.152 0,0" style="fill:#42602f;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path988"></path>
        </g>
        <g id="g990" transform="translate(158.0811,158.9687)">
          <path d="M 0,0 C 5.083,-1.322 -0.351,2.117 -1.395,4.611 -2.44,7.107 0.338,11.93 2.558,11.488 4.777,11.045 7.723,7.367 9.254,8.59 c 2.511,2.012 -1.508,3.543 -2.197,6.125 -0.688,2.578 3.293,4.594 5.214,2.998 1.92,-1.592 2.906,-2.951 4.158,-2.106 1.254,0.852 -0.862,2.372 -1.144,4.168 -0.283,1.793 9.414,4.944 12.677,4.891 2.694,-1.84 8.761,-10.125 7.495,-11.428 -1.267,-1.302 -4.247,-1.343 -3.711,-2.759 0.534,-1.416 2.498,-0.856 4.985,-0.663 2.488,0.196 4.581,-3.748 2.53,-5.457 -2.052,-1.709 -6.032,-0.836 -5.264,-3.773 0.699,-2.674 5.008,-0.539 7.077,-1.457 2.07,-0.922 1.558,-6.461 -0.736,-7.897 -2.292,-1.435 -10.612,0.233 -5.493,-2.845 4.502,-2.709 8.405,-0.375 4.347,-6.756 -4.06,-6.383 -23.013,-0.824 -23.013,-0.824 l -3.85,1.353 c 0,0 -19.441,6.463 -18.326,13.945 C -5.156,1.752 -3.107,0.807 0,0" style="fill:#bfd24a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path992"></path>
        </g>
        <g id="g994">
          <g id="g996"></g>
          <g id="g1008">
            <g clip-path="url(#clipPath1000)" opacity="0.100006" id="g1006">
              <g transform="translate(164.3486,149.3262)" id="g1004">
                <path d="m 0,0 c -6.799,2.799 -6.424,6.4 2.555,3.627 7.091,-2.191 2.338,2.012 -1.142,5.811 -3.481,3.796 0.351,5.263 5.663,3.322 5.31,-1.94 5.073,-1.336 1.935,3.826 -4.475,7.363 -0.946,7.361 3.163,3.305 4.107,-4.059 3.201,4.425 5.53,5.879 2.329,1.451 1.41,-4.696 0.487,-7.481 -0.919,-2.785 4.346,-0.824 5.867,-2.779 1.521,-1.957 -7.131,-1.867 -8.183,-5.024 C 14.822,7.332 22.73,7.377 25.134,6.025 27.537,4.676 21.644,2.35 16.476,2.32 c -5.167,-0.031 -5.615,-4.195 0.402,-5.299 6.02,-1.103 7.012,-4.857 0.179,-3.986 -3.951,0.502 -6.22,-0.84 -7.457,-2.478 l -3.538,1.246 c 0,0 -0.606,0.207 -1.585,0.586 C 4.546,-4.932 3.787,-1.559 0,0" style="fill:#414042;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1002"></path>
              </g>
            </g>
          </g>
        </g>
        <g id="g1010" transform="translate(163.5278,152.2324)">
          <path d="m 0,0 c 0.023,0.051 0.441,-0.088 1.205,-0.393 0.76,-0.32 1.894,-0.748 3.265,-1.443 0.69,-0.34 1.453,-0.719 2.287,-1.127 0.737,-0.4 1.536,-0.83 2.377,-1.285 0.858,2.832 1.716,5.492 2.568,7.951 C 9.458,5.068 7.583,6.141 6.22,6.904 4.594,7.791 3.705,8.316 3.745,8.4 3.77,8.451 4.186,8.313 4.95,8.01 5.709,7.687 6.844,7.26 8.215,6.564 8.905,6.223 9.668,5.848 10.501,5.436 10.98,5.178 11.493,4.9 12.018,4.617 c 0.184,0.531 0.364,1.053 0.543,1.561 0.221,0.592 0.438,1.172 0.646,1.736 0.342,0.906 0.662,1.762 0.992,2.58 -1.365,2.217 -2.536,4.01 -3.398,5.303 -1.045,1.529 -1.597,2.404 -1.523,2.459 0.045,0.037 0.353,-0.277 0.894,-0.897 0.531,-0.63 1.348,-1.529 2.25,-2.771 0.46,-0.619 0.969,-1.303 1.523,-2.047 0.219,-0.314 0.447,-0.646 0.68,-0.986 0.337,0.82 0.661,1.605 0.959,2.328 0.386,0.844 0.74,1.619 1.059,2.322 0.62,1.404 1.23,2.455 1.615,3.182 0.4,0.72 0.635,1.09 0.685,1.066 0.084,-0.039 -0.271,-1.012 -0.97,-2.724 -0.598,-1.516 -1.409,-3.627 -2.328,-6.247 0.872,0.147 1.68,0.278 2.408,0.401 1.513,0.267 2.724,0.347 3.543,0.433 0.819,0.069 1.259,0.084 1.266,0.026 0.014,-0.094 -0.989,-0.338 -2.803,-0.715 -1.229,-0.27 -2.845,-0.639 -4.75,-1.113 C 15.291,10.461 15.273,10.41 15.256,10.359 14.714,8.787 14.163,7.055 13.566,5.193 13.427,4.729 13.283,4.254 13.137,3.771 c 0.506,-0.095 1.002,-0.189 1.465,-0.277 0.906,-0.203 1.739,-0.39 2.489,-0.558 1.503,-0.323 2.656,-0.702 3.447,-0.93 0.786,-0.244 1.196,-0.399 1.182,-0.453 -0.02,-0.09 -1.044,0.058 -2.865,0.39 -1.484,0.258 -3.518,0.584 -5.992,0.92 -0.357,-1.177 -0.719,-2.396 -1.068,-3.666 -0.414,-1.449 -0.83,-2.957 -1.244,-4.509 1.013,-0.241 1.968,-0.465 2.846,-0.672 0.896,-0.25 1.72,-0.479 2.461,-0.68 1.485,-0.395 2.619,-0.826 3.397,-1.094 0.773,-0.281 1.179,-0.453 1.161,-0.508 -0.024,-0.089 -1.041,0.108 -2.844,0.528 -1.729,0.383 -4.211,0.906 -7.281,1.445 -0.708,-2.684 -1.411,-5.496 -2.103,-8.404 -2.083,-8.649 -4.04,-18.11 -5.785,-27.36 -0.806,0.309 -1.672,0.485 -2.543,0.536 0.575,2.753 1.174,5.525 1.794,8.287 2.196,9.863 4.676,19.601 7.184,27.998 -2.636,1.625 -4.823,2.879 -6.363,3.74 C 0.849,-0.609 -0.04,-0.084 0,0" style="fill:#42602f;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1012"></path>
        </g>
        <g id="g1014" transform="translate(197.7437,69.0254)">
          <path d="m 0,0 c 8.211,8.361 13.281,19.814 13.281,32.461 0,8.887 -2.507,17.187 -6.848,24.24 H 2.076 v 7.153 h -70.269 v -7.153 h -4.357 c -4.34,-7.053 -6.847,-15.353 -6.847,-24.24 0,-12.647 5.07,-24.1 13.281,-32.461 z" style="fill-opacity: 1; fill-rule: nonzero; stroke: none; fill: rgb(126, 91, 58);" id="path1016"></path>
        </g>
        <g id="g1018">
          <g id="g1020"></g>
          <g id="g1032">
            <g clip-path="url(#clipPath1024)" opacity="0.100006" id="g1030">
              <g transform="translate(138.9395,69.0254)" id="g1028">
                <path d="m 0,0 h 58.804 c 8.211,8.361 13.281,19.814 13.281,32.461 0,8.887 -2.507,17.187 -6.848,24.24 H 60.88 25.446 c 0,0 24.897,-5.279 24.897,-24.775 C 50.343,11.605 26.704,0.965 0,0" style="fill-opacity: 1; fill-rule: nonzero; stroke: none; fill: rgb(38, 38, 39);" id="path1026"></path>
              </g>
            </g>
          </g>
        </g>
      </g>
    </g>
  </g>
</svg></div></div>
<br>
<h2 id="6-avoid-large-objects">6. Avoid large objects</h2>
<p>As explained in section 2, engines use shapes to optimize objects. However, when the shape grows too large, the engine has no choice but to use a regular hashmap (like a <code>Map</code> object). And as we saw in section 5, cache misses decrease performance significantly. Hashmaps are prone to this because their data is usually randomly &amp; evenly distributed over the memory region they occupy. Let’s see how it behaves with this map of some users indexed by their ID.</p>
<div id="benchmark-large-object" class="code-blocks"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// setup:</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> USERS_LENGTH</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> 1_000</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// setup:</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> byId</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> {}</span></span>
<span data-line=""><span style="color:#ADBAC7">Array.</span><span style="color:#DCBDFB">from</span><span style="color:#ADBAC7">({ length: </span><span style="color:#6CB6FF">USERS_LENGTH</span><span style="color:#ADBAC7"> }).</span><span style="color:#DCBDFB">forEach</span><span style="color:#ADBAC7">((</span><span style="color:#F69D50">_</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">id</span><span style="color:#ADBAC7">) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#ADBAC7">  byId[id] </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> { id, name: </span><span style="color:#96D0FF">'John'</span><span style="color:#ADBAC7">}</span></span>
<span data-line=""><span style="color:#ADBAC7">})</span></span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> _ </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 1. [] access</span></span>
<span data-line=""><span style="color:#ADBAC7">Object.</span><span style="color:#DCBDFB">keys</span><span style="color:#ADBAC7">(byId).</span><span style="color:#DCBDFB">forEach</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">id</span><span style="color:#F47067"> =&gt;</span><span style="color:#ADBAC7"> { _ </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> byId[id].id })</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 2. direct access</span></span>
<span data-line=""><span style="color:#ADBAC7">Object.</span><span style="color:#DCBDFB">values</span><span style="color:#ADBAC7">(byId).</span><span style="color:#DCBDFB">forEach</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">user</span><span style="color:#F47067"> =&gt;</span><span style="color:#ADBAC7"> { _ </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> user.id })</span></span></code></pre></figure></div>
<astro-island uid="197NPq" prefix="r8" component-url="/_astro/Benchmark.848f928f.js" component-export="default" renderer-url="/_astro/client.06fbcffe.js" props="{&quot;selector&quot;:[0,&quot;#benchmark-large-object&quot;],&quot;results&quot;:[0,{&quot;1. [] access&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,49173],&quot;percent&quot;:[0,43.18]}],&quot;2. direct access&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,113887],&quot;percent&quot;:[0,100]}]}]}" client="load" opts="{&quot;name&quot;:&quot;Benchmark&quot;,&quot;value&quot;:true}" await-children=""><div class="flex md:flex-row flex-col gap-4 mb-2"><div class="flex-1 mb-1 grid grid-cols-[max-content_auto]"><div class="w-max-content pr-4"><b class="text-sm">1. [] access:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">2. direct access:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div></div><div><button class="w-20">Show</button></div></div></astro-island>
<p>And we can also observe how the performance keeps degrading as the object size grows:</p>
<div id="benchmark-large-object-larger" class="code-blocks"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// setup:</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> USERS_LENGTH</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> 100_000</span></span></code></pre></figure><div class="hidden"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// setup:</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> byId</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> {}</span></span>
<span data-line=""><span style="color:#ADBAC7">Array.</span><span style="color:#DCBDFB">from</span><span style="color:#ADBAC7">({ length: </span><span style="color:#6CB6FF">USERS_LENGTH</span><span style="color:#ADBAC7"> }).</span><span style="color:#DCBDFB">forEach</span><span style="color:#ADBAC7">((</span><span style="color:#F69D50">_</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">id</span><span style="color:#ADBAC7">) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#ADBAC7">  byId[id] </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> { id, name: </span><span style="color:#96D0FF">'John'</span><span style="color:#ADBAC7">}</span></span>
<span data-line=""><span style="color:#ADBAC7">})</span></span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> _ </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 1. [] access</span></span>
<span data-line=""><span style="color:#ADBAC7">Object.</span><span style="color:#DCBDFB">keys</span><span style="color:#ADBAC7">(byId).</span><span style="color:#DCBDFB">forEach</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">id</span><span style="color:#F47067"> =&gt;</span><span style="color:#ADBAC7"> { _ </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> byId[id].id })</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 2. direct access</span></span>
<span data-line=""><span style="color:#ADBAC7">Object.</span><span style="color:#DCBDFB">values</span><span style="color:#ADBAC7">(byId).</span><span style="color:#DCBDFB">forEach</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">user</span><span style="color:#F47067"> =&gt;</span><span style="color:#ADBAC7"> { _ </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> user.id })</span></span></code></pre></figure></div></div>
<astro-island uid="ZgXYDC" prefix="r9" component-url="/_astro/Benchmark.848f928f.js" component-export="default" renderer-url="/_astro/client.06fbcffe.js" props="{&quot;selector&quot;:[0,&quot;#benchmark-large-object-larger&quot;],&quot;results&quot;:[0,{&quot;1. [] access&quot;:[0,{&quot;runTime&quot;:[0,-1005],&quot;amountOfRounds&quot;:[0,229],&quot;percent&quot;:[0,20.67]}],&quot;2. direct access&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,1108],&quot;percent&quot;:[0,100]}]}]}" client="load" opts="{&quot;name&quot;:&quot;Benchmark&quot;,&quot;value&quot;:true}" await-children=""><div class="flex md:flex-row flex-col gap-4 mb-2"><div class="flex-1 mb-1 grid grid-cols-[max-content_auto]"><div class="w-max-content pr-4"><b class="text-sm">1. [] access:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">2. direct access:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div></div><div><button class="w-20">Show</button></div></div></astro-island>
<h4 id="what-the-eff-should-i-do-about-this-3">What the eff should I do about this?</h4>
<p>As demonstrated above, avoid having to frequently index into large objects. Prefer turning the object into an array beforehand. Organizing your data to have the ID on the model can help, as you can use <code>Object.values()</code> and not have to refer to the key map to get the ID.</p>
<h2 id="7-use-eval">7. Use eval</h2>
<p>Some javascript patterns are hard to optimize for engines, and by using <code>eval()</code> or its derivatives you can make those patterns disappear. In this example, we can observe how using <code>eval()</code> avoids the cost of creating an object with a dynamic object key:</p>
<div id="benchmark-eval" class="code-blocks"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// setup:</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> key</span><span style="color:#F47067"> =</span><span style="color:#96D0FF"> 'requestId'</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> values</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> Array.</span><span style="color:#DCBDFB">from</span><span style="color:#ADBAC7">({ length: </span><span style="color:#6CB6FF">100_000</span><span style="color:#ADBAC7"> }).</span><span style="color:#DCBDFB">fill</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">42</span><span style="color:#ADBAC7">)</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 1. without eval</span></span>
<span data-line=""><span style="color:#F47067">function</span><span style="color:#DCBDFB"> createMessages</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">key</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">values</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#F47067">  const</span><span style="color:#6CB6FF"> messages</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> []</span></span>
<span data-line=""><span style="color:#F47067">  for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#ADBAC7"> values.</span><span style="color:#6CB6FF">length</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#ADBAC7">    messages.</span><span style="color:#DCBDFB">push</span><span style="color:#ADBAC7">({ [key]: values[i] })</span></span>
<span data-line=""><span style="color:#ADBAC7">  }</span></span>
<span data-line=""><span style="color:#F47067">  return</span><span style="color:#ADBAC7"> messages</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#DCBDFB">createMessages</span><span style="color:#ADBAC7">(key, values)</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 2. with eval</span></span>
<span data-line=""><span style="color:#F47067">function</span><span style="color:#DCBDFB"> createMessages</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">key</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">values</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#F47067">  const</span><span style="color:#6CB6FF"> messages</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> []</span></span>
<span data-line=""><span style="color:#F47067">  const</span><span style="color:#6CB6FF"> createMessage</span><span style="color:#F47067"> =</span><span style="color:#F47067"> new</span><span style="color:#DCBDFB"> Function</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">'value'</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#96D0FF">    `return { ${</span><span style="color:#6CB6FF">JSON</span><span style="color:#96D0FF">.</span><span style="color:#DCBDFB">stringify</span><span style="color:#96D0FF">(</span><span style="color:#ADBAC7">key</span><span style="color:#96D0FF">)</span><span style="color:#96D0FF">}: value }`</span></span>
<span data-line=""><span style="color:#ADBAC7">  )</span></span>
<span data-line=""><span style="color:#F47067">  for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#ADBAC7"> values.</span><span style="color:#6CB6FF">length</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#ADBAC7">    messages.</span><span style="color:#DCBDFB">push</span><span style="color:#ADBAC7">(</span><span style="color:#DCBDFB">createMessage</span><span style="color:#ADBAC7">(values[i]))</span></span>
<span data-line=""><span style="color:#ADBAC7">  }</span></span>
<span data-line=""><span style="color:#F47067">  return</span><span style="color:#ADBAC7"> messages</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#DCBDFB">createMessages</span><span style="color:#ADBAC7">(key, values)</span></span></code></pre></figure></div>
<astro-island uid="Lnsd9" prefix="r10" component-url="/_astro/Benchmark.848f928f.js" component-export="default" renderer-url="/_astro/client.06fbcffe.js" props="{&quot;selector&quot;:[0,&quot;#benchmark-eval&quot;],&quot;results&quot;:[0,{&quot;1. without eval&quot;:[0,{&quot;runTime&quot;:[0,-1005],&quot;amountOfRounds&quot;:[0,233],&quot;percent&quot;:[0,53.2]}],&quot;2. with eval&quot;:[0,{&quot;runTime&quot;:[0,-1001],&quot;amountOfRounds&quot;:[0,438],&quot;percent&quot;:[0,100]}]}]}" client="load" opts="{&quot;name&quot;:&quot;Benchmark&quot;,&quot;value&quot;:true}" await-children=""><div class="flex md:flex-row flex-col gap-4 mb-2"><div class="flex-1 mb-1 grid grid-cols-[max-content_auto]"><div class="w-max-content pr-4"><b class="text-sm">1. without eval:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">2. with eval:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div></div><div><button class="w-20">Show</button></div></div></astro-island>
<p>Another good use-case for <code>eval</code> could be to compile a filter predicate function where you discard the branches that you know will never be taken. In general, any function that is going to be run in a very hot loop is a good candidate for this kind of optimization.</p>
<p>Obviously the usual warnings about <code>eval()</code> apply: don’t trust user input, sanitize anything that gets passed into the <code>eval()</code>‘d code, and don’t create any XSS possibility. Also note that some environments don’t allow access to <code>eval()</code>, such as browser pages with a CSP.</p>
<h2 id="8-use-strings-carefully">8. Use strings, carefully</h2>
<p>We’ve already seen above how strings are more expensive than they appear. Well I have kind of a good news/bad news situation here, which I’ll announce in the only logical order (bad first, good second): strings are more complex than they appear, but they can also be quite efficient used well.</p>
<p>String operations are a core part of JavaScript due to its context. To optimize string-heavy code, engines had to be creative. And by that I mean, they had to represent the <code>String</code> object with multiple string representation in C++, depending on the use case. There are two general cases you should worry about, because they hold true for V8 (the most common engine by far), and generally also in other engines.</p>
<p>First, strings concatenated with <code>+</code> don’t create a copy of the two input strings. The operation creates a pointer to each substring. If it was in typescript, it would be something like this:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="typescript" data-theme="github-dark-dimmed"><code data-language="typescript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#F47067">class</span><span style="color:#F69D50"> String</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#F47067">  abstract</span><span style="color:#DCBDFB"> value</span><span style="color:#ADBAC7">()</span><span style="color:#F47067">:</span><span style="color:#F69D50"> char</span><span style="color:#ADBAC7">[] {}</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">class</span><span style="color:#F69D50"> BytesString</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#F47067">  constructor</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">bytes</span><span style="color:#F47067">:</span><span style="color:#F69D50"> char</span><span style="color:#ADBAC7">[]) {</span></span>
<span data-line=""><span style="color:#6CB6FF">    this</span><span style="color:#ADBAC7">.bytes </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> bytes</span></span>
<span data-line=""><span style="color:#ADBAC7">  }</span></span>
<span data-line=""><span style="color:#DCBDFB">  value</span><span style="color:#ADBAC7">() {</span></span>
<span data-line=""><span style="color:#F47067">    return</span><span style="color:#6CB6FF"> this</span><span style="color:#ADBAC7">.bytes</span></span>
<span data-line=""><span style="color:#ADBAC7">  }</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">class</span><span style="color:#F69D50"> ConcatenatedString</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#F47067">  constructor</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">left</span><span style="color:#F47067">:</span><span style="color:#F69D50"> String</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">right</span><span style="color:#F47067">:</span><span style="color:#F69D50"> String</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#6CB6FF">    this</span><span style="color:#ADBAC7">.left </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> left</span></span>
<span data-line=""><span style="color:#6CB6FF">    this</span><span style="color:#ADBAC7">.right </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> right</span></span>
<span data-line=""><span style="color:#ADBAC7">  }</span></span>
<span data-line=""><span style="color:#DCBDFB">  value</span><span style="color:#ADBAC7">() {</span></span>
<span data-line=""><span style="color:#F47067">    return</span><span style="color:#ADBAC7"> [</span><span style="color:#F47067">...</span><span style="color:#6CB6FF">this</span><span style="color:#ADBAC7">.left.</span><span style="color:#DCBDFB">value</span><span style="color:#ADBAC7">(), </span><span style="color:#F47067">...</span><span style="color:#6CB6FF">this</span><span style="color:#ADBAC7">.right.</span><span style="color:#DCBDFB">value</span><span style="color:#ADBAC7">()]</span></span>
<span data-line=""><span style="color:#ADBAC7">  }</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">function</span><span style="color:#DCBDFB"> concat</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">left</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">right</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#F47067">  return</span><span style="color:#F47067"> new</span><span style="color:#DCBDFB"> ConcatenatedString</span><span style="color:#ADBAC7">(left, right)</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> first</span><span style="color:#F47067"> =</span><span style="color:#F47067"> new</span><span style="color:#DCBDFB"> BytesString</span><span style="color:#ADBAC7">([</span><span style="color:#96D0FF">'H'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'e'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'l'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'l'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'o'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">' '</span><span style="color:#ADBAC7">])</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> second</span><span style="color:#F47067"> =</span><span style="color:#F47067"> new</span><span style="color:#DCBDFB"> BytesString</span><span style="color:#ADBAC7">([</span><span style="color:#96D0FF">'w'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'o'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'r'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'l'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'d'</span><span style="color:#ADBAC7">])</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#768390">// See ma, no array copies!</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> message</span><span style="color:#F47067"> =</span><span style="color:#DCBDFB"> concat</span><span style="color:#ADBAC7">(first, second)</span></span></code></pre></figure>
<p>Second, string slices also don’t need to create copies: they can simply point to a range in another string. To continue with the example above:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="typescript" data-theme="github-dark-dimmed"><code data-language="typescript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#F47067">class</span><span style="color:#F69D50"> SlicedString</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#F47067">  constructor</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">source</span><span style="color:#F47067">:</span><span style="color:#F69D50"> String</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">start</span><span style="color:#F47067">:</span><span style="color:#6CB6FF"> number</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">end</span><span style="color:#F47067">:</span><span style="color:#6CB6FF"> number</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#6CB6FF">    this</span><span style="color:#ADBAC7">.source </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> source</span></span>
<span data-line=""><span style="color:#6CB6FF">    this</span><span style="color:#ADBAC7">.start </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> start</span></span>
<span data-line=""><span style="color:#6CB6FF">    this</span><span style="color:#ADBAC7">.end </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> end</span></span>
<span data-line=""><span style="color:#ADBAC7">  }</span></span>
<span data-line=""><span style="color:#DCBDFB">  value</span><span style="color:#ADBAC7">() {</span></span>
<span data-line=""><span style="color:#F47067">    return</span><span style="color:#6CB6FF"> this</span><span style="color:#ADBAC7">.source.</span><span style="color:#DCBDFB">value</span><span style="color:#ADBAC7">().</span><span style="color:#DCBDFB">slice</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">this</span><span style="color:#ADBAC7">.start, </span><span style="color:#6CB6FF">this</span><span style="color:#ADBAC7">.end)</span></span>
<span data-line=""><span style="color:#ADBAC7">  }</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">function</span><span style="color:#DCBDFB"> substring</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">source</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">start</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">end</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#F47067">  return</span><span style="color:#F47067"> new</span><span style="color:#DCBDFB"> SlicedString</span><span style="color:#ADBAC7">(source, start, end)</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#768390">// This represents "He", but it still contains no array copies.</span></span>
<span data-line=""><span style="color:#768390">// It's a SlicedString to a ConcatenatedString to two BytesString</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> firstTwoLetters</span><span style="color:#F47067"> =</span><span style="color:#DCBDFB"> substring</span><span style="color:#ADBAC7">(message, </span><span style="color:#6CB6FF">0</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">2</span><span style="color:#ADBAC7">)</span></span></code></pre></figure>
<p>But here’s the issue: once you need to start mutating those bytes, that’s the moment you start paying copy costs. Let’s say we go back to our <code>String</code> class and try to add a <code>.trimEnd</code> method:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="typescript" data-theme="github-dark-dimmed"><code data-language="typescript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#F47067">class</span><span style="color:#F69D50"> String</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#F47067">  abstract</span><span style="color:#DCBDFB"> value</span><span style="color:#ADBAC7">()</span><span style="color:#F47067">:</span><span style="color:#F69D50"> char</span><span style="color:#ADBAC7">[] {}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#DCBDFB">  trimEnd</span><span style="color:#ADBAC7">() {</span></span>
<span data-line=""><span style="color:#768390">    // `.value()` here might be calling</span></span>
<span data-line=""><span style="color:#768390">    // our Sliced-&gt;Concatenated-&gt;2*Bytes string!</span></span>
<span data-line=""><span style="color:#F47067">    const</span><span style="color:#6CB6FF"> bytes</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> this</span><span style="color:#ADBAC7">.</span><span style="color:#DCBDFB">value</span><span style="color:#ADBAC7">()</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">    const</span><span style="color:#6CB6FF"> result</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> bytes.</span><span style="color:#DCBDFB">slice</span><span style="color:#ADBAC7">()</span></span>
<span data-line=""><span style="color:#F47067">    while</span><span style="color:#ADBAC7"> (result[result.</span><span style="color:#6CB6FF">length</span><span style="color:#F47067"> -</span><span style="color:#6CB6FF"> 1</span><span style="color:#ADBAC7">] </span><span style="color:#F47067">===</span><span style="color:#96D0FF"> ' '</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">      result.</span><span style="color:#DCBDFB">pop</span><span style="color:#ADBAC7">()</span></span>
<span data-line=""><span style="color:#F47067">    return</span><span style="color:#F47067"> new</span><span style="color:#DCBDFB"> BytesString</span><span style="color:#ADBAC7">(result)</span></span>
<span data-line=""><span style="color:#ADBAC7">  }</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure>
<p>So let’s jump to an example where we compare using operations that use mutation versus only using concatenation:</p>
<div id="benchmark-strings" class="code-blocks"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// setup:</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> classNames</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> [</span><span style="color:#96D0FF">'primary'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'selected'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'active'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'medium'</span><span style="color:#ADBAC7">]</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 1. mutation</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> result</span><span style="color:#F47067"> =</span></span>
<span data-line=""><span style="color:#ADBAC7">  classNames</span></span>
<span data-line=""><span style="color:#ADBAC7">    .</span><span style="color:#DCBDFB">map</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">c</span><span style="color:#F47067"> =&gt;</span><span style="color:#96D0FF"> `button--${</span><span style="color:#ADBAC7">c</span><span style="color:#96D0FF">}`</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">    .</span><span style="color:#DCBDFB">join</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">' '</span><span style="color:#ADBAC7">)</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 2. concatenation</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> result</span><span style="color:#F47067"> =</span></span>
<span data-line=""><span style="color:#ADBAC7">  classNames</span></span>
<span data-line=""><span style="color:#ADBAC7">    .</span><span style="color:#DCBDFB">map</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">c</span><span style="color:#F47067"> =&gt;</span><span style="color:#96D0FF"> 'button--'</span><span style="color:#F47067"> +</span><span style="color:#ADBAC7"> c)</span></span>
<span data-line=""><span style="color:#ADBAC7">    .</span><span style="color:#DCBDFB">reduce</span><span style="color:#ADBAC7">((</span><span style="color:#F69D50">acc</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">c</span><span style="color:#ADBAC7">) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> acc </span><span style="color:#F47067">+</span><span style="color:#96D0FF"> ' '</span><span style="color:#F47067"> +</span><span style="color:#ADBAC7"> c, </span><span style="color:#96D0FF">''</span><span style="color:#ADBAC7">)</span></span></code></pre></figure></div>
<astro-island uid="NLyaA" prefix="r11" component-url="/_astro/Benchmark.848f928f.js" component-export="default" renderer-url="/_astro/client.06fbcffe.js" props="{&quot;selector&quot;:[0,&quot;#benchmark-strings&quot;],&quot;iterations&quot;:[0,5000],&quot;results&quot;:[0,{&quot;1. mutation&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,1808],&quot;percent&quot;:[0,37.43]}],&quot;2. concatenation&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,4830],&quot;percent&quot;:[0,100]}]}]}" client="load" opts="{&quot;name&quot;:&quot;Benchmark&quot;,&quot;value&quot;:true}" await-children=""><div class="flex md:flex-row flex-col gap-4 mb-2"><div class="flex-1 mb-1 grid grid-cols-[max-content_auto]"><div class="w-max-content pr-4"><b class="text-sm">1. mutation:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">2. concatenation:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div></div><div><button class="w-20">Show</button></div></div></astro-island>
<h4 id="what-the-eff-should-i-do-about-this-4">What the eff should I do about this?</h4>
<p>In general, try to <strong>avoid mutation for as long as possible</strong>. This includes methods such as <code>.trim()</code>, <code>.replace()</code>, etc. Consider how you can avoid those methods. In some engines, string templates can also be slower than <code>+</code>. In V8 at the moment it’s the case, but might not be in the future so as always, benchmark.</p>
<p>A note on <code>SlicedString</code> above, you should note that if a small substring to a very large string is alive in memory, <mark title="it will, in V8">it might</mark> prevent the garbage collector from collecting the large string! If you’re processing large texts and extracting small strings from it, you might be leaking large amounts of memory.</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> large</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> Array.</span><span style="color:#DCBDFB">from</span><span style="color:#ADBAC7">({ length: </span><span style="color:#6CB6FF">10_000</span><span style="color:#ADBAC7"> }).</span><span style="color:#DCBDFB">map</span><span style="color:#ADBAC7">(() </span><span style="color:#F47067">=&gt;</span><span style="color:#96D0FF"> 'string'</span><span style="color:#ADBAC7">).</span><span style="color:#DCBDFB">join</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">''</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> small</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> large.</span><span style="color:#DCBDFB">slice</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">0</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">50</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#768390">//    ^ will keep `large` alive</span></span></code></pre></figure>
<p>The solution here is to use mutation methods to our advantage. If we use one of them on <code>small</code>, it will force a copy, and the old pointer to <code>large</code> will be lost:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// replace a token that doesn't exist</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> small</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> small.</span><span style="color:#DCBDFB">replace</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">'#'</span><span style="color:#ADBAC7">.</span><span style="color:#DCBDFB">repeat</span><span style="color:#ADBAC7">(small.</span><span style="color:#6CB6FF">length</span><span style="color:#F47067"> +</span><span style="color:#6CB6FF"> 1</span><span style="color:#ADBAC7">), </span><span style="color:#96D0FF">''</span><span style="color:#ADBAC7">)</span></span></code></pre></figure>
<p>For more details, see <a href="https://github.com/v8/v8/blob/main/src/objects/string.h">string.h on V8</a> or <a href="https://github.com/WebKit/WebKit/blob/main/Source/JavaScriptCore/runtime/JSString.h">JSString.h on JavaScriptCore</a>.</p>
<aside class="aside aside-info "><h6><svg width="1em" height="1em" viewBox="0 0 16 16" data-icon="octicon:info-16"><use xlink:href="#ai:octicon:info-16"></use></svg><span>On strings complexity</span></h6><p>I have skimmed very quickly over things, but there are a lot of implementation details that add complexity to strings. There are often minimum lengths for each of those string representations. For example a concatenated string might not be used for very small strings. Or sometimes there are limits, for example avoiding pointing to a substring of a substring. Reading the C++ files linked above gives a good overview of the implementation details, even if just reading the comments.</p></aside>
<h2 id="9-use-specialization">9. Use specialization</h2>
<p>One important concept in performance optimization is <em>specialization</em>: adapting your logic to fit in the constraints of your particular use-case. This usually means figuring out what conditions are <em>likely</em> to be true for your case, and coding for those conditions.</p>
<p>Let’s say we are a merchant that sometimes needs to add tags to their product list. We know from experience that our tags are usually empty. Knowing that information, we can specialize our function for that case:</p>
<div id="benchmark-specialization" class="code-blocks"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// setup:</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> descriptions</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> [</span><span style="color:#96D0FF">'apples'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'oranges'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'bananas'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'seven'</span><span style="color:#ADBAC7">]</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> someTags</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#ADBAC7">  apples: </span><span style="color:#96D0FF">'::promotion::'</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> noTags</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> {}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#768390">// Turn the products into a string, with their tags if applicable</span></span>
<span data-line=""><span style="color:#F47067">function</span><span style="color:#DCBDFB"> productsToString</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">description</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">tags</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#F47067">  let</span><span style="color:#ADBAC7"> result </span><span style="color:#F47067">=</span><span style="color:#96D0FF"> ''</span></span>
<span data-line=""><span style="color:#ADBAC7">  description.</span><span style="color:#DCBDFB">forEach</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">product</span><span style="color:#F47067"> =&gt;</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#ADBAC7">    result </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> product</span></span>
<span data-line=""><span style="color:#F47067">    if</span><span style="color:#ADBAC7"> (tags[product]) result </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> tags[product]</span></span>
<span data-line=""><span style="color:#ADBAC7">    result </span><span style="color:#F47067">+=</span><span style="color:#96D0FF"> ', '</span></span>
<span data-line=""><span style="color:#ADBAC7">  })</span></span>
<span data-line=""><span style="color:#F47067">  return</span><span style="color:#ADBAC7"> result</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#768390">// Specialize it now</span></span>
<span data-line=""><span style="color:#F47067">function</span><span style="color:#DCBDFB"> productsToStringSpecialized</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">description</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">tags</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#768390">  // We know that `tags` is likely to be empty, so we check</span></span>
<span data-line=""><span style="color:#768390">  // once ahead of time, and then we can remove the `if` check</span></span>
<span data-line=""><span style="color:#768390">  // from the inner loop</span></span>
<span data-line=""><span style="color:#F47067">  if</span><span style="color:#ADBAC7"> (</span><span style="color:#DCBDFB">isEmpty</span><span style="color:#ADBAC7">(tags)) {</span></span>
<span data-line=""><span style="color:#F47067">    let</span><span style="color:#ADBAC7"> result </span><span style="color:#F47067">=</span><span style="color:#96D0FF"> ''</span></span>
<span data-line=""><span style="color:#ADBAC7">    description.</span><span style="color:#DCBDFB">forEach</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">product</span><span style="color:#F47067"> =&gt;</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#ADBAC7">      result </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> product </span><span style="color:#F47067">+</span><span style="color:#96D0FF"> ', '</span></span>
<span data-line=""><span style="color:#ADBAC7">    })</span></span>
<span data-line=""><span style="color:#F47067">    return</span><span style="color:#ADBAC7"> result</span></span>
<span data-line=""><span style="color:#ADBAC7">  } </span><span style="color:#F47067">else</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#F47067">    let</span><span style="color:#ADBAC7"> result </span><span style="color:#F47067">=</span><span style="color:#96D0FF"> ''</span></span>
<span data-line=""><span style="color:#ADBAC7">    description.</span><span style="color:#DCBDFB">forEach</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">product</span><span style="color:#F47067"> =&gt;</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#ADBAC7">      result </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> product</span></span>
<span data-line=""><span style="color:#F47067">      if</span><span style="color:#ADBAC7"> (tags[product]) result </span><span style="color:#F47067">+=</span><span style="color:#ADBAC7"> tags[product]</span></span>
<span data-line=""><span style="color:#ADBAC7">      result </span><span style="color:#F47067">+=</span><span style="color:#96D0FF"> ', '</span></span>
<span data-line=""><span style="color:#ADBAC7">    })</span></span>
<span data-line=""><span style="color:#F47067">    return</span><span style="color:#ADBAC7"> result</span></span>
<span data-line=""><span style="color:#ADBAC7">  }</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""><span style="color:#F47067">function</span><span style="color:#DCBDFB"> isEmpty</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">o</span><span style="color:#ADBAC7">) { </span><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> _ </span><span style="color:#F47067">in</span><span style="color:#ADBAC7"> o) { </span><span style="color:#F47067">return</span><span style="color:#6CB6FF"> false</span><span style="color:#ADBAC7"> } </span><span style="color:#F47067">return</span><span style="color:#6CB6FF"> true</span><span style="color:#ADBAC7"> }</span></span>
<span data-line=""> </span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 1. not specialized</span></span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#6CB6FF"> 100</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#DCBDFB">  productsToString</span><span style="color:#ADBAC7">(descriptions, someTags)</span></span>
<span data-line=""><span style="color:#DCBDFB">  productsToString</span><span style="color:#ADBAC7">(descriptions, noTags)</span></span>
<span data-line=""><span style="color:#DCBDFB">  productsToString</span><span style="color:#ADBAC7">(descriptions, noTags)</span></span>
<span data-line=""><span style="color:#DCBDFB">  productsToString</span><span style="color:#ADBAC7">(descriptions, noTags)</span></span>
<span data-line=""><span style="color:#DCBDFB">  productsToString</span><span style="color:#ADBAC7">(descriptions, noTags)</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 2. specialized</span></span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#6CB6FF"> 100</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#DCBDFB">  productsToStringSpecialized</span><span style="color:#ADBAC7">(descriptions, someTags)</span></span>
<span data-line=""><span style="color:#DCBDFB">  productsToStringSpecialized</span><span style="color:#ADBAC7">(descriptions, noTags)</span></span>
<span data-line=""><span style="color:#DCBDFB">  productsToStringSpecialized</span><span style="color:#ADBAC7">(descriptions, noTags)</span></span>
<span data-line=""><span style="color:#DCBDFB">  productsToStringSpecialized</span><span style="color:#ADBAC7">(descriptions, noTags)</span></span>
<span data-line=""><span style="color:#DCBDFB">  productsToStringSpecialized</span><span style="color:#ADBAC7">(descriptions, noTags)</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure></div>
<astro-island uid="Zjg8vk" prefix="r12" component-url="/_astro/Benchmark.848f928f.js" component-export="default" renderer-url="/_astro/client.06fbcffe.js" props="{&quot;selector&quot;:[0,&quot;#benchmark-specialization&quot;],&quot;iterations&quot;:[0,5000],&quot;results&quot;:[0,{&quot;1. not specialized&quot;:[0,{&quot;runTime&quot;:[0,-1118],&quot;amountOfRounds&quot;:[0,6],&quot;percent&quot;:[0,85.71]}],&quot;2. specialized&quot;:[0,{&quot;runTime&quot;:[0,-1062],&quot;amountOfRounds&quot;:[0,7],&quot;percent&quot;:[0,100]}]}]}" client="load" opts="{&quot;name&quot;:&quot;Benchmark&quot;,&quot;value&quot;:true}" await-children=""><div class="flex md:flex-row flex-col gap-4 mb-2"><div class="flex-1 mb-1 grid grid-cols-[max-content_auto]"><div class="w-max-content pr-4"><b class="text-sm">1. not specialized:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">2. specialized:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div></div><div><button class="w-20">Show</button></div></div></astro-island>
<p>This sort of optimization can give you moderate improvements, but those will add up. They are a nice addition to more crucial optimizations, like shapes and memory I/O. But note that specialization can turn against you if your conditions change, so be careful when applying this one.</p>
<aside class="aside aside-info "><h6><svg width="1em" height="1em" viewBox="0 0 16 16" data-icon="octicon:info-16"><use xlink:href="#ai:octicon:info-16"></use></svg><span>Branch prediction and branchless code</span></h6><p>Removing branches from your code can be incredibly efficient for performance. For more details on what a branch predictor is, read the classic Stack&nbsp;Overflow answer <a href="https://stackoverflow.com/questions/11227809/why-is-processing-a-sorted-array-faster-than-processing-an-unsorted-array">Why is processing a sorted array faster</a>.</p></aside>
<br>
<h2 id="10-data-structures">10. Data structures</h2>
<p>I won’t go in details about data structures as they would require their own post. But be aware that using the incorrect data structures for your use-case can have a <strong>bigger impact than any of the optimizations above</strong>. I would suggest you to be familiar with the native ones like <code>Map</code> and <code>Set</code>, and to learn about linked lists, priority queues, trees (RB and B+) and tries.</p>
<p>But for a quick example, let’s compare how <code>Array.includes</code> does against <code>Set.has</code> for a small list:</p>
<div id="benchmark-data-structures" class="code-blocks"><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// setup:</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> userIds</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> Array.</span><span style="color:#DCBDFB">from</span><span style="color:#ADBAC7">({ length: </span><span style="color:#6CB6FF">1_000</span><span style="color:#ADBAC7"> }).</span><span style="color:#DCBDFB">map</span><span style="color:#ADBAC7">((</span><span style="color:#F69D50">_</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">i</span><span style="color:#ADBAC7">) </span><span style="color:#F47067">=&gt;</span><span style="color:#ADBAC7"> i)</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> adminIdsArray</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> userIds.</span><span style="color:#DCBDFB">slice</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">0</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">10</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> adminIdsSet</span><span style="color:#F47067"> =</span><span style="color:#F47067"> new</span><span style="color:#DCBDFB"> Set</span><span style="color:#ADBAC7">(adminIdsArray)</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 1. Array</span></span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> _ </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span></span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#ADBAC7"> userIds.</span><span style="color:#6CB6FF">length</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#F47067">  if</span><span style="color:#ADBAC7"> (adminIdsArray.</span><span style="color:#DCBDFB">includes</span><span style="color:#ADBAC7">(userIds[i])) { _ </span><span style="color:#F47067">+=</span><span style="color:#6CB6FF"> 1</span><span style="color:#ADBAC7"> }</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure><figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#768390">// 2. Set</span></span>
<span data-line=""><span style="color:#F47067">let</span><span style="color:#ADBAC7"> _ </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span></span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#ADBAC7"> userIds.</span><span style="color:#6CB6FF">length</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#F47067">  if</span><span style="color:#ADBAC7"> (adminIdsSet.</span><span style="color:#DCBDFB">has</span><span style="color:#ADBAC7">(userIds[i])) { _ </span><span style="color:#F47067">+=</span><span style="color:#6CB6FF"> 1</span><span style="color:#ADBAC7"> }</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure></div>
<astro-island uid="5pfsu" prefix="r13" component-url="/_astro/Benchmark.848f928f.js" component-export="default" renderer-url="/_astro/client.06fbcffe.js" props="{&quot;selector&quot;:[0,&quot;#benchmark-data-structures&quot;],&quot;results&quot;:[0,{&quot;1. Array&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,89836],&quot;percent&quot;:[0,34.27]}],&quot;2. Set&quot;:[0,{&quot;runTime&quot;:[0,-1000],&quot;amountOfRounds&quot;:[0,262116],&quot;percent&quot;:[0,100]}]}]}" client="load" opts="{&quot;name&quot;:&quot;Benchmark&quot;,&quot;value&quot;:true}" await-children=""><div class="flex md:flex-row flex-col gap-4 mb-2"><div class="flex-1 mb-1 grid grid-cols-[max-content_auto]"><div class="w-max-content pr-4"><b class="text-sm">1. Array:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div><div class="w-max-content pr-4"><b class="text-sm">2. Set:</b></div><div class="grid place-items-center"><div class="relative rounded-lg bg-blue-300/10 overflow-hidden text-center font-bold h-6 p-0 text-sm w-full"><div class="bg-blue-500/80 absolute top-0 left-0 h-full transition-all" style="width: 0%;"></div><span class="absolute top-0.5 m-auto left-0 right-0">0%</span></div></div></div><div><button class="w-20">Show</button></div></div></astro-island>
<p>As you can see, the data structure choice makes a very impactful difference.</p>
<p>As a real-world example, I had a case where we were able to <a href="https://github.com/mui/mui-x/pull/9200">reduce the runtime of a function from 5 seconds to 22 milliseconds</a> by switching out an array with a linked list.</p>
<div class="random-plant"><div class="random-plant-svg mt-8 mb-16"><!--?xml version="1.0" encoding="utf-8"?-->
<svg viewBox="120.252 310.289 129.641 226.433" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <clippath clipPathUnits="userSpaceOnUse" id="clipPath20">
      <path d="M 0,500 H 750 V 0 H 0 Z" id="path18"></path>
    </clippath>
    <clippath clipPathUnits="userSpaceOnUse" id="clipPath952">
      <path d="m 127.158,187.434 h 38.934 v -44.2 h -38.934 z" id="path950"></path>
    </clippath>
    <clippath clipPathUnits="userSpaceOnUse" id="clipPath976">
      <path d="m 141.202,223.736 h 51.365 v -62.865 h -51.365 z" id="path974"></path>
    </clippath>
    <clippath clipPathUnits="userSpaceOnUse" id="clipPath1000">
      <path d="m 159.658,175.314 h 30.378 v -35.431 h -30.378 z" id="path998"></path>
    </clippath>
    <clippath clipPathUnits="userSpaceOnUse" id="clipPath1024">
      <path d="m 138.939,125.727 h 72.085 V 69.0254 h -72.085 z" id="path1022"></path>
    </clippath>
  </defs>
  <g id="g8" transform="matrix(1.3333332538604736, 0, 0, -1.3333332538604736, 0, 666.6666870117188)">
    <g id="g14">
      <g id="g16" clip-path="url(#clipPath20)" transform="matrix(1, 0, 0, 1, -23.605152, 28.433477)">
        <g id="g942" transform="translate(167.4219,169.3613)">
          <path d="m 0,0 c -6.334,-2.256 0.209,2.738 1.259,6.039 1.049,3.299 -3.036,9.135 -5.817,8.32 -2.782,-0.814 -6.121,-5.838 -8.212,-4.447 -3.428,2.279 1.524,4.688 2.11,8.057 0.589,3.365 -4.717,5.484 -6.987,3.236 -2.269,-2.25 -3.373,-4.096 -5.064,-3.156 -1.694,0.943 0.833,3.121 0.989,5.441 0.158,2.321 -12.563,5.242 -16.717,4.809 -3.228,-2.649 -10.03,-13.903 -8.269,-15.418 1.762,-1.52 5.565,-1.235 5.043,-3.1 -0.521,-1.867 -3.088,-1.373 -6.282,-1.406 -3.194,-0.035 -5.417,-5.295 -2.611,-7.246 2.808,-1.947 7.787,-0.389 7.139,-4.219 -0.591,-3.488 -6.326,-1.252 -8.86,-2.656 -2.534,-1.406 -1.256,-8.414 1.829,-9.984 3.085,-1.577 13.507,1.492 7.326,-3.012 -5.435,-3.959 -10.675,-1.424 -4.78,-9.106 5.897,-7.679 29.439,1.543 29.439,1.543 l 4.758,2.164 c 0,0 24.059,10.438 21.794,19.85 C 6.377,2.816 3.871,1.379 0,0" style="fill:#84980d;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path944"></path>
        </g>
        <g id="g946">
          <g id="g948"></g>
          <g id="g960">
            <g clip-path="url(#clipPath952)" opacity="0.100006" id="g958">
              <g transform="translate(160.5181,156.3594)" id="g956">
                <path d="m 0,0 c 8.353,4.334 7.468,8.887 -3.667,4.336 -8.794,-3.596 -3.21,2.303 0.799,7.537 4.012,5.236 -1.04,6.672 -7.594,3.598 -6.555,-3.073 -6.32,-2.278 -2.901,4.662 4.876,9.896 0.374,9.494 -4.406,3.857 -4.78,-5.638 -4.582,5.281 -7.715,6.871 -3.134,1.59 -1.268,-6.144 0.22,-9.593 1.489,-3.448 -5.445,-1.543 -7.164,-4.206 -1.72,-2.669 9.302,-1.576 11.001,-5.482 1.698,-3.904 -8.39,-4.74 -11.304,-6.732 -2.913,-1.994 4.864,-4.289 11.459,-3.748 6.593,0.541 7.634,-4.717 0.083,-6.805 -7.552,-2.086 -8.392,-6.983 0.222,-5.104 4.982,1.088 8.028,-0.367 9.791,-2.316 l 4.373,1.986 c 0,0 0.747,0.332 1.955,0.926 C -5.24,-6.803 -4.653,-2.418 0,0" style="fill:#414042;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path954"></path>
              </g>
            </g>
          </g>
        </g>
        <g id="g962" transform="translate(161.2373,160.1582)">
          <path d="m 0,0 c -0.037,0.061 -0.553,-0.162 -1.493,-0.637 -0.933,-0.494 -2.331,-1.168 -4,-2.209 -0.842,-0.515 -1.773,-1.08 -2.79,-1.701 -0.896,-0.588 -1.866,-1.226 -2.887,-1.904 -1.413,3.513 -2.808,6.814 -4.17,9.851 2.705,1.993 4.977,3.573 6.628,4.702 1.973,1.312 3.048,2.084 2.988,2.185 -0.036,0.065 -0.552,-0.162 -1.493,-0.637 -0.932,-0.49 -2.33,-1.164 -4,-2.207 -0.842,-0.513 -1.773,-1.08 -2.789,-1.697 -0.58,-0.383 -1.204,-0.795 -1.842,-1.215 -0.294,0.653 -0.584,1.301 -0.868,1.926 -0.347,0.732 -0.689,1.447 -1.02,2.143 -0.538,1.117 -1.042,2.171 -1.555,3.179 1.491,2.983 2.781,5.399 3.734,7.145 1.16,2.066 1.765,3.244 1.664,3.306 -0.062,0.041 -0.418,-0.392 -1.04,-1.242 -0.605,-0.865 -1.544,-2.103 -2.556,-3.791 -0.515,-0.84 -1.086,-1.767 -1.711,-2.779 -0.242,-0.426 -0.495,-0.875 -0.755,-1.334 -0.522,1.008 -1.024,1.973 -1.485,2.861 -0.588,1.032 -1.127,1.979 -1.612,2.838 -0.951,1.723 -1.846,2.992 -2.42,3.877 -0.59,0.871 -0.931,1.319 -0.994,1.281 -0.101,-0.06 0.46,-1.257 1.545,-3.365 0.933,-1.863 2.207,-4.467 3.673,-7.699 -1.128,0.086 -2.173,0.164 -3.114,0.236 -1.96,0.17 -3.513,0.137 -4.569,0.155 -1.052,-0.004 -1.614,-0.039 -1.618,-0.112 -0.006,-0.119 1.301,-0.32 3.656,-0.593 1.598,-0.208 3.701,-0.495 6.183,-0.885 0.03,-0.065 0.058,-0.125 0.087,-0.194 0.867,-1.939 1.766,-4.088 2.736,-6.394 0.23,-0.58 0.468,-1.168 0.708,-1.764 -0.634,-0.178 -1.256,-0.353 -1.836,-0.515 -1.134,-0.366 -2.173,-0.7 -3.111,-0.999 -1.88,-0.578 -3.308,-1.191 -4.291,-1.574 -0.975,-0.4 -1.481,-0.642 -1.458,-0.711 0.037,-0.113 1.326,0.19 3.61,0.823 1.866,0.494 4.421,1.14 7.538,1.849 0.588,-1.463 1.186,-2.972 1.774,-4.553 0.694,-1.802 1.394,-3.679 2.097,-5.613 -1.264,-0.418 -2.457,-0.816 -3.554,-1.181 -1.115,-0.415 -2.137,-0.797 -3.062,-1.141 -1.849,-0.672 -3.244,-1.35 -4.208,-1.779 -0.954,-0.446 -1.452,-0.711 -1.423,-0.776 0.042,-0.115 1.315,0.252 3.566,0.99 2.164,0.684 5.269,1.627 9.123,2.666 1.206,-3.343 2.418,-6.849 3.63,-10.478 3.632,-10.795 7.195,-22.637 10.466,-34.238 0.992,0.486 2.075,0.806 3.182,0.968 -1.045,3.45 -2.122,6.915 -3.224,10.368 -3.912,12.328 -8.176,24.464 -12.32,34.89 3.18,2.371 5.826,4.217 7.691,5.49 C -1.015,-0.877 0.06,-0.104 0,0" style="fill:#42602f;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path964"></path>
        </g>
        <g id="g966" transform="translate(135.582,189.002)">
          <path d="m 0,0 c 9.038,-0.834 -1.188,3.514 -3.664,7.479 -2.476,3.964 0.92,12.958 4.829,12.824 3.909,-0.135 9.955,-5.588 12.226,-3.074 3.721,4.126 -3.558,5.623 -5.452,9.83 -1.892,4.207 4.339,8.748 8.058,6.566 3.718,-2.184 5.779,-4.229 7.678,-2.436 1.9,1.799 -2.131,3.805 -3.112,6.788 -0.98,2.98 14.68,11.052 20.258,11.871 5.108,-2.387 17.76,-14.828 15.963,-17.403 -1.797,-2.574 -6.867,-3.474 -5.561,-5.74 1.306,-2.266 4.499,-0.764 8.686,0.262 4.188,1.021 8.854,-5.119 5.834,-8.606 -3.023,-3.484 -10.054,-3.105 -7.926,-7.9 1.936,-4.363 8.689,0.475 12.474,-0.516 3.785,-0.992 4.453,-10.584 0.941,-13.67 -3.508,-3.086 -18.162,-2.556 -8.576,-6.384 8.432,-3.364 14.439,1.701 9.294,-10.311 -5.146,-12.016 -39.017,-7.812 -39.017,-7.812 l -6.944,1.24 c 0,0 -34.952,5.615 -35.134,18.683 C -9.281,1.555 -5.523,0.514 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path968"></path>
        </g>
        <g id="g970">
          <g id="g972"></g>
          <g id="g984">
            <g clip-path="url(#clipPath976)" opacity="0.100006" id="g982">
              <g transform="translate(150.2285,174.3027)" id="g980">
                <path d="m 0,0 c -12.374,2.881 -12.735,9.131 3.348,6.898 12.703,-1.765 3.428,4.082 -3.565,9.59 -6.993,5.506 -0.865,9.074 8.733,7.242 9.597,-1.828 9.025,-0.869 2.236,7.063 -9.681,11.312 -3.66,12.293 4.475,6.516 8.134,-5.774 4.228,8.441 7.794,11.564 C 26.59,52 26.732,41.262 25.937,36.254 25.141,31.248 33.574,36.057 36.713,33.145 39.852,30.229 25.072,27.979 24.156,22.301 23.239,16.627 36.712,18.906 41.187,17.27 45.662,15.637 36.258,10.035 27.453,8.543 c -8.804,-1.492 -8.409,-8.717 2.162,-8.926 10.573,-0.205 13.307,-6.33 1.414,-6.75 -6.878,-0.242 -10.376,-3.16 -12.03,-6.299 l -6.381,1.139 c 0,0 -1.09,0.184 -2.865,0.557 C 9.125,-7.145 6.893,-1.604 0,0" style="fill:#414042;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path978"></path>
              </g>
            </g>
          </g>
        </g>
        <g id="g986" transform="translate(148.02,179.0312)">
          <path d="m 0,0 c 0.026,0.094 0.776,-0.025 2.164,-0.334 1.384,-0.332 3.44,-0.748 5.969,-1.553 1.273,-0.388 2.68,-0.82 4.217,-1.289 1.366,-0.47 2.85,-0.984 4.412,-1.529 0.673,5.068 1.396,9.85 2.164,14.275 -4.204,1.705 -7.701,3.012 -10.239,3.938 -3.02,1.055 -4.683,1.707 -4.638,1.859 0.027,0.096 0.777,-0.025 2.164,-0.332 1.385,-0.334 3.439,-0.75 5.97,-1.553 1.272,-0.39 2.68,-0.82 4.215,-1.291 0.887,-0.304 1.838,-0.634 2.813,-0.972 0.166,0.955 0.33,1.898 0.493,2.81 0.211,1.073 0.419,2.123 0.618,3.145 0.331,1.637 0.637,3.187 0.971,4.678 -2.943,3.398 -5.439,6.128 -7.268,8.095 -2.208,2.315 -3.393,3.653 -3.281,3.77 0.066,0.072 0.678,-0.375 1.774,-1.281 1.081,-0.928 2.723,-2.233 4.609,-4.1 0.955,-0.928 2.012,-1.951 3.166,-3.066 0.458,-0.477 0.941,-0.981 1.433,-1.493 0.347,1.494 0.682,2.918 0.989,4.235 0.423,1.547 0.811,2.97 1.159,4.256 0.668,2.568 1.414,4.529 1.868,5.878 0.482,1.334 0.779,2.034 0.873,2.006 0.154,-0.045 -0.18,-1.8 -0.897,-4.918 -0.596,-2.748 -1.394,-6.578 -2.231,-11.297 1.448,0.489 2.787,0.94 3.994,1.35 2.505,0.879 4.549,1.354 5.922,1.727 1.379,0.347 2.124,0.492 2.154,0.396 0.049,-0.154 -1.595,-0.851 -4.582,-2 -2.022,-0.801 -4.675,-1.879 -7.792,-3.221 -0.016,-0.093 -0.032,-0.183 -0.049,-0.277 -0.486,-2.83 -0.942,-5.941 -1.442,-9.283 -0.109,-0.832 -0.222,-1.68 -0.337,-2.541 0.889,-0.024 1.761,-0.041 2.575,-0.063 C 25.533,9.928 27.003,9.84 28.333,9.762 30.983,9.631 33.055,9.307 34.468,9.135 35.875,8.938 36.62,8.789 36.612,8.691 36.601,8.533 34.814,8.5 31.616,8.563 29.014,8.584 25.453,8.578 21.14,8.465 20.86,6.355 20.581,4.178 20.34,1.914 c -0.304,-2.588 -0.593,-5.275 -0.867,-8.039 1.793,-0.125 3.485,-0.244 5.041,-0.355 1.597,-0.174 3.063,-0.332 4.385,-0.473 2.643,-0.258 4.696,-0.68 6.099,-0.918 1.396,-0.266 2.135,-0.447 2.12,-0.543 -0.017,-0.162 -1.804,-0.107 -4.995,0.107 -3.058,0.17 -7.434,0.37 -12.821,0.44 -0.46,-4.776 -0.875,-9.768 -1.249,-14.92 -1.143,-15.328 -1.848,-32.004 -2.251,-48.27 -1.462,0.305 -2.987,0.364 -4.486,0.205 0.215,4.856 0.465,9.75 0.753,14.635 1.001,17.43 2.522,34.725 4.461,49.744 -4.949,2.039 -9.028,3.569 -11.892,4.61 C 1.618,-0.805 -0.045,-0.152 0,0" style="fill:#42602f;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path988"></path>
        </g>
        <g id="g990" transform="translate(158.0811,158.9687)">
          <path d="M 0,0 C 5.083,-1.322 -0.351,2.117 -1.395,4.611 -2.44,7.107 0.338,11.93 2.558,11.488 4.777,11.045 7.723,7.367 9.254,8.59 c 2.511,2.012 -1.508,3.543 -2.197,6.125 -0.688,2.578 3.293,4.594 5.214,2.998 1.92,-1.592 2.906,-2.951 4.158,-2.106 1.254,0.852 -0.862,2.372 -1.144,4.168 -0.283,1.793 9.414,4.944 12.677,4.891 2.694,-1.84 8.761,-10.125 7.495,-11.428 -1.267,-1.302 -4.247,-1.343 -3.711,-2.759 0.534,-1.416 2.498,-0.856 4.985,-0.663 2.488,0.196 4.581,-3.748 2.53,-5.457 -2.052,-1.709 -6.032,-0.836 -5.264,-3.773 0.699,-2.674 5.008,-0.539 7.077,-1.457 2.07,-0.922 1.558,-6.461 -0.736,-7.897 -2.292,-1.435 -10.612,0.233 -5.493,-2.845 4.502,-2.709 8.405,-0.375 4.347,-6.756 -4.06,-6.383 -23.013,-0.824 -23.013,-0.824 l -3.85,1.353 c 0,0 -19.441,6.463 -18.326,13.945 C -5.156,1.752 -3.107,0.807 0,0" style="fill:#bfd24a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path992"></path>
        </g>
        <g id="g994">
          <g id="g996"></g>
          <g id="g1008">
            <g clip-path="url(#clipPath1000)" opacity="0.100006" id="g1006">
              <g transform="translate(164.3486,149.3262)" id="g1004">
                <path d="m 0,0 c -6.799,2.799 -6.424,6.4 2.555,3.627 7.091,-2.191 2.338,2.012 -1.142,5.811 -3.481,3.796 0.351,5.263 5.663,3.322 5.31,-1.94 5.073,-1.336 1.935,3.826 -4.475,7.363 -0.946,7.361 3.163,3.305 4.107,-4.059 3.201,4.425 5.53,5.879 2.329,1.451 1.41,-4.696 0.487,-7.481 -0.919,-2.785 4.346,-0.824 5.867,-2.779 1.521,-1.957 -7.131,-1.867 -8.183,-5.024 C 14.822,7.332 22.73,7.377 25.134,6.025 27.537,4.676 21.644,2.35 16.476,2.32 c -5.167,-0.031 -5.615,-4.195 0.402,-5.299 6.02,-1.103 7.012,-4.857 0.179,-3.986 -3.951,0.502 -6.22,-0.84 -7.457,-2.478 l -3.538,1.246 c 0,0 -0.606,0.207 -1.585,0.586 C 4.546,-4.932 3.787,-1.559 0,0" style="fill:#414042;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1002"></path>
              </g>
            </g>
          </g>
        </g>
        <g id="g1010" transform="translate(163.5278,152.2324)">
          <path d="m 0,0 c 0.023,0.051 0.441,-0.088 1.205,-0.393 0.76,-0.32 1.894,-0.748 3.265,-1.443 0.69,-0.34 1.453,-0.719 2.287,-1.127 0.737,-0.4 1.536,-0.83 2.377,-1.285 0.858,2.832 1.716,5.492 2.568,7.951 C 9.458,5.068 7.583,6.141 6.22,6.904 4.594,7.791 3.705,8.316 3.745,8.4 3.77,8.451 4.186,8.313 4.95,8.01 5.709,7.687 6.844,7.26 8.215,6.564 8.905,6.223 9.668,5.848 10.501,5.436 10.98,5.178 11.493,4.9 12.018,4.617 c 0.184,0.531 0.364,1.053 0.543,1.561 0.221,0.592 0.438,1.172 0.646,1.736 0.342,0.906 0.662,1.762 0.992,2.58 -1.365,2.217 -2.536,4.01 -3.398,5.303 -1.045,1.529 -1.597,2.404 -1.523,2.459 0.045,0.037 0.353,-0.277 0.894,-0.897 0.531,-0.63 1.348,-1.529 2.25,-2.771 0.46,-0.619 0.969,-1.303 1.523,-2.047 0.219,-0.314 0.447,-0.646 0.68,-0.986 0.337,0.82 0.661,1.605 0.959,2.328 0.386,0.844 0.74,1.619 1.059,2.322 0.62,1.404 1.23,2.455 1.615,3.182 0.4,0.72 0.635,1.09 0.685,1.066 0.084,-0.039 -0.271,-1.012 -0.97,-2.724 -0.598,-1.516 -1.409,-3.627 -2.328,-6.247 0.872,0.147 1.68,0.278 2.408,0.401 1.513,0.267 2.724,0.347 3.543,0.433 0.819,0.069 1.259,0.084 1.266,0.026 0.014,-0.094 -0.989,-0.338 -2.803,-0.715 -1.229,-0.27 -2.845,-0.639 -4.75,-1.113 C 15.291,10.461 15.273,10.41 15.256,10.359 14.714,8.787 14.163,7.055 13.566,5.193 13.427,4.729 13.283,4.254 13.137,3.771 c 0.506,-0.095 1.002,-0.189 1.465,-0.277 0.906,-0.203 1.739,-0.39 2.489,-0.558 1.503,-0.323 2.656,-0.702 3.447,-0.93 0.786,-0.244 1.196,-0.399 1.182,-0.453 -0.02,-0.09 -1.044,0.058 -2.865,0.39 -1.484,0.258 -3.518,0.584 -5.992,0.92 -0.357,-1.177 -0.719,-2.396 -1.068,-3.666 -0.414,-1.449 -0.83,-2.957 -1.244,-4.509 1.013,-0.241 1.968,-0.465 2.846,-0.672 0.896,-0.25 1.72,-0.479 2.461,-0.68 1.485,-0.395 2.619,-0.826 3.397,-1.094 0.773,-0.281 1.179,-0.453 1.161,-0.508 -0.024,-0.089 -1.041,0.108 -2.844,0.528 -1.729,0.383 -4.211,0.906 -7.281,1.445 -0.708,-2.684 -1.411,-5.496 -2.103,-8.404 -2.083,-8.649 -4.04,-18.11 -5.785,-27.36 -0.806,0.309 -1.672,0.485 -2.543,0.536 0.575,2.753 1.174,5.525 1.794,8.287 2.196,9.863 4.676,19.601 7.184,27.998 -2.636,1.625 -4.823,2.879 -6.363,3.74 C 0.849,-0.609 -0.04,-0.084 0,0" style="fill:#42602f;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1012"></path>
        </g>
        <g id="g1014" transform="translate(197.7437,69.0254)">
          <path d="m 0,0 c 8.211,8.361 13.281,19.814 13.281,32.461 0,8.887 -2.507,17.187 -6.848,24.24 H 2.076 v 7.153 h -70.269 v -7.153 h -4.357 c -4.34,-7.053 -6.847,-15.353 -6.847,-24.24 0,-12.647 5.07,-24.1 13.281,-32.461 z" style="fill-opacity: 1; fill-rule: nonzero; stroke: none; fill: rgb(126, 91, 58);" id="path1016"></path>
        </g>
        <g id="g1018">
          <g id="g1020"></g>
          <g id="g1032">
            <g clip-path="url(#clipPath1024)" opacity="0.100006" id="g1030">
              <g transform="translate(138.9395,69.0254)" id="g1028">
                <path d="m 0,0 h 58.804 c 8.211,8.361 13.281,19.814 13.281,32.461 0,8.887 -2.507,17.187 -6.848,24.24 H 60.88 25.446 c 0,0 24.897,-5.279 24.897,-24.775 C 50.343,11.605 26.704,0.965 0,0" style="fill-opacity: 1; fill-rule: nonzero; stroke: none; fill: rgb(38, 38, 39);" id="path1026"></path>
              </g>
            </g>
          </g>
        </g>
      </g>
    </g>
  </g>
</svg></div></div>
<h2 id="11-benchmarking">11. Benchmarking</h2>
<p>I’ve left this section for the end for one reason: I needed to establish credibility with the fun sections above. Now that I (hopefully) have it, let me tell you that benchmarking is the most important part of optimization. Not only is it the most important, but it’s also <em>hard</em>. Even after 20 years of experience, I still sometimes create benchmarks that are flawed, or use the profiling tools incorrectly. So whatever you do, please <strong>put the most effort into benchmarking correctly</strong>.</p>
<h3 id="110-start-with-the-top">11.0 Start with the top</h3>
<p>Your priority should always be to optimize the function/section of code that makes up the biggest part of your runtime. If you spend time optimizing anything else than the top, you are wasting time.</p>
<h3 id="111-avoid-micro-benchmarks">11.1 Avoid micro-benchmarks</h3>
<p>Run your code in production mode and base your optimizations on those observations. JS engines are very complex, and will often behave differently in micro-benchmarks than in real-world scenarios. For example, take this micro-benchmark:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="javascript" data-theme="github-dark-dimmed"><code data-language="javascript" data-theme="github-dark-dimmed" style="display:grid"><span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> a</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { type: </span><span style="color:#96D0FF">'div'</span><span style="color:#ADBAC7">, count: </span><span style="color:#6CB6FF">5</span><span style="color:#ADBAC7">, }</span></span>
<span data-line=""><span style="color:#F47067">const</span><span style="color:#6CB6FF"> b</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> { type: </span><span style="color:#96D0FF">'span'</span><span style="color:#ADBAC7">, count: </span><span style="color:#6CB6FF">10</span><span style="color:#ADBAC7"> }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">function</span><span style="color:#DCBDFB"> typeEquals</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">a</span><span style="color:#ADBAC7">, </span><span style="color:#F69D50">b</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#F47067">  return</span><span style="color:#ADBAC7"> a.type </span><span style="color:#F47067">===</span><span style="color:#ADBAC7"> b.type</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F47067">for</span><span style="color:#ADBAC7"> (</span><span style="color:#F47067">let</span><span style="color:#ADBAC7"> i </span><span style="color:#F47067">=</span><span style="color:#6CB6FF"> 0</span><span style="color:#ADBAC7">; i </span><span style="color:#F47067">&lt;</span><span style="color:#6CB6FF"> 100_000</span><span style="color:#ADBAC7">; i</span><span style="color:#F47067">++</span><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#DCBDFB">  typeEquals</span><span style="color:#ADBAC7">(a, b)</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure>
<p>If you’ve payed attention sooner, you will realize that the engine will specialize the function for the shape <code>{ type: string, count: number }</code>. But does that hold true in your real-world use-case? Are <code>a</code> and <code>b</code> always of that shape, or will you receive any kind of shape? If you receive many shapes in production, this function will behave differently then.</p>
<h3 id="112-doubt-your-results">11.2 Doubt your results</h3>
<p>If you’ve just optimized a function and it now runs 100x faster, doubt it. Try to disprove your results, try it in production mode, throw stuff at it. Similarly, doubt also your tools. The mere fact of observing a benchmark with devtools can modify its behavior.</p>
<h3 id="113-pick-your-target">11.3 Pick your target</h3>
<p>Different engines will optimize certain patterns better or worse than others. You should benchmark for the engine(s) that are relevant to you, and prioritize which one is more important. <a href="https://github.com/babel/babel/pull/16357">Here’s a real-world example</a> in Babel where improving V8 means decreasing JSC’s performance.</p>
<h2 id="12-profiling--tools">12. Profiling &amp; tools</h2>
<p>Various remarks about profiling and devtools.</p>
<h3 id="121-browser-gotchas">12.1 Browser gotchas</h3>
<p>If you’re profiling in the browser, make sure you use a clean and empty browser profile. I even use a separate browser for this. If you’re profiling and you have browser extensions enabled, they can mess up the measurements. React devtools in particular will substantially affect results, rendering code may appear slower than it appears <del>in the mirror</del> to your users.</p>
<h3 id="122-sample-vs-structural-profiling">12.2 Sample vs structural profiling</h3>
<p>Browser profiling tools are sample-based profilers, which take a sample of your stack at regular intervals. This had a big disadvantage: very small but very frequent functions might be called between those samples, and might be very much underreported in the stack charts you’ll get. Use Firefox devtools with a custom sample interval or Chrome devtools with CPU throttling to mitigate this issue.</p>
<h3 id="123-the-tools-of-the-trade">12.3 The tools of the trade</h3>
<p>Beyond the regular browser devtools, it may help to be aware of these options:</p>
<ul>
<li>
<p>Chrome devtools have quite a few experimental flags that can help you figure out why things are slow. The style invalidation tracker is invaluable when you need to debug style/layout recalculations in the browser.<br>
<a href="https://github.com/iamakulov/devtools-perf-features">https://github.com/iamakulov/devtools-perf-features</a></p>
</li>
<li>
<p>The deoptexplorer-vscode extension allows you to load V8/chromium log files to understand when your code is triggering deoptimizations, such as when you pass different shapes to a function. You don’t need the extension to read log files, but it makes the experience much more pleasant.<br>
<a href="https://github.com/microsoft/deoptexplorer-vscode">https://github.com/microsoft/deoptexplorer-vscode</a></p>
</li>
<li>
<p>You can always compile the debug shell for each JS engine to understand more in details how it works. This allows you to run <code>perf</code> and other low-level tools, and also to inspect the bytecode and machine code generated by each engine.<br>
<a href="https://mrale.ph/blog/2018/02/03/maybe-you-dont-need-rust-to-speed-up-your-js.html#getting-the-code">Example for V8</a> | <a href="https://zon8.re/posts/jsc-internals-part1-tracing-js-source-to-bytecode/">Example for JSC</a> | <span class="text-neutral-500">Example for SpiderMonkey (missing)</span></p>
</li>
</ul>
<h2 id="final-notes">Final notes</h2>
<p>Hope you learned some useful tricks. If you have any comments, corrections or questions, email in the footer. I’m always happy to receive feedback or questions from readers.</p>
<div class="random-plant"><div class="random-plant-svg mt-8 mb-32"><!--?xml version="1.0" encoding="utf-8"?-->
<svg viewBox="0.676 3.248 167.1 229.192" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <clippath clipPathUnits="userSpaceOnUse" id="clipPath20">
      <path d="M 0,500 H 750 V 0 H 0 Z" id="path18"></path>
    </clippath>
    <clippath clipPathUnits="userSpaceOnUse" id="clipPath1236">
      <path d="m 274.911,142.879 h 82.59 V 69.0039 h -82.59 z" id="path1234"></path>
    </clippath>
  </defs>
  <g id="g8" transform="matrix(1.3333332538604736, 0, 0, -1.3333332538604736, 0, 666.6666870117186)">
    <g id="g14">
      <g id="g16" clip-path="url(#clipPath20)" transform="matrix(1, 0, 0, 1, -23.605152, 28.433477)">
        <g id="g1034" transform="matrix(1, 0, 0, 1, 88.026978, 343.501404)">
          <path d="m 0,0 c -0.293,-0.049 -0.584,0.26 -0.643,0.678 0,0 -0.291,1.965 -0.626,5.412 -0.33,3.449 -0.704,8.385 -0.807,14.32 -0.221,11.844 0.671,27.791 4.675,43.164 1.972,7.674 4.746,15.16 8.187,21.764 3.394,6.631 7.535,12.301 11.572,16.68 0.497,0.554 0.986,1.097 1.463,1.628 0.495,0.514 1.02,0.973 1.509,1.446 0.99,0.929 1.929,1.812 2.813,2.644 1.885,1.52 3.551,2.823 4.923,3.891 2.913,1.902 4.579,2.988 4.579,2.988 0.354,0.237 0.767,0.211 0.922,-0.052 0.145,-0.249 -0.02,-0.637 -0.367,-0.87 0,0 -1.64,-1.068 -4.508,-2.941 -1.349,-1.053 -2.988,-2.334 -4.845,-3.828 -0.868,-0.819 -1.793,-1.69 -2.768,-2.606 -0.482,-0.463 -0.999,-0.916 -1.486,-1.422 -0.469,-0.523 -0.949,-1.056 -1.44,-1.603 C 19.176,96.982 15.094,91.395 11.741,84.842 8.341,78.318 5.595,70.912 3.64,63.303 -0.331,48.066 -1.221,32.207 -1,20.43 -0.898,14.529 -0.526,9.619 -0.199,6.195 0.134,2.77 0.422,0.83 0.423,0.83 0.48,0.416 0.293,0.049 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1036"></path>
        </g>
        <g id="g1038" transform="matrix(1, 0, 0, 1, 120.202271, 436.684998)">
          <path d="m 0,0 c -3.124,0.162 -6.1,1.602 -8.217,3.068 -2.114,1.45 -3.389,2.971 -3.39,2.971 0,0 0.538,0.441 1.445,1.102 0.917,0.646 2.156,1.556 3.661,2.361 1.553,0.754 3.296,1.477 5.023,1.951 1.796,0.399 3.618,0.494 5.202,0.209 C 4.521,11.52 5.25,11.328 5.917,11.105 6.594,10.865 7.229,10.561 7.786,10.254 8.906,9.627 9.773,8.91 10.406,8.162 11.667,6.658 12.021,5.033 11.448,3.674 10.967,2.174 9.637,1.217 7.662,0.66 5.797,-0.027 3.057,-0.086 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1040"></path>
        </g>
        <g id="g1042" transform="matrix(1, 0, 0, 1, 101.508972, 453.792419)">
          <path d="m 0,0 c -0.114,-3.766 1.731,-6.461 3.529,-8.285 1.818,-1.826 3.557,-2.783 3.557,-2.783 0,0 0.373,0.572 0.935,1.547 0.572,0.962 1.288,2.375 2.108,3.953 0.871,1.529 1.776,3.295 2.53,5.156 0.818,1.781 1.537,3.603 1.84,5.402 0.153,0.895 0.264,1.746 0.33,2.549 0.077,0.789 0.128,1.498 0.118,2.178 -0.013,1.347 -0.223,2.494 -0.632,3.39 -0.811,1.795 -2.444,2.586 -4.73,2.081 C 7.4,14.553 4.996,12.715 3.152,10.033 1.421,7.232 0.034,3.824 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1044"></path>
        </g>
        <g id="g1046" transform="matrix(1, 0, 0, 1, 125.418091, 463.366699)">
          <path d="m 0,0 c -3.466,-1.475 -5.138,-4.279 -6.04,-6.678 -0.896,-2.416 -1.034,-4.396 -1.034,-4.396 0,0 0.676,-0.1 1.796,-0.199 1.115,-0.118 2.697,-0.172 4.473,-0.256 1.752,-0.151 3.737,-0.231 5.742,-0.133 1.96,0.004 3.915,0.115 5.675,0.596 0.876,0.234 1.696,0.49 2.452,0.769 0.749,0.262 1.414,0.512 2.027,0.805 1.218,0.578 2.17,1.248 2.812,1.996 1.291,1.488 1.325,3.305 -0.095,5.166 C 16.316,-0.613 13.64,0.799 10.431,1.348 7.164,1.746 3.487,1.574 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1048"></path>
        </g>
        <g id="g1050" transform="matrix(1, 0, 0, 1, 110.368286, 422.427216)">
          <path d="m 0,0 c -3.057,-0.777 -6.28,-0.162 -8.695,0.713 -2.422,0.869 -4.036,2.016 -4.036,2.016 0,0 0.39,0.572 1.071,1.457 0.343,0.441 0.749,0.964 1.231,1.523 0.513,0.543 1.09,1.125 1.714,1.715 1.246,1.18 2.661,2.408 4.304,3.291 0.801,0.453 1.615,0.851 2.428,1.162 0.807,0.314 1.62,0.535 2.464,0.605 3.318,0.323 5.793,-0.291 7.442,-1.337 C 9.568,10.094 10.401,8.617 10.288,7.076 10.237,6.297 9.912,5.605 9.429,4.908 8.965,4.193 8.284,3.537 7.394,2.949 6.952,2.65 6.442,2.387 5.912,2.109 5.398,1.818 4.833,1.545 4.221,1.291 3.001,0.779 1.566,0.361 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1052"></path>
        </g>
        <g id="g1054" transform="matrix(1, 0, 0, 1, 87.81897, 433.985809)">
          <path d="M 0,0 C 0.972,-3.594 3.466,-5.732 5.675,-7.041 7.89,-8.342 9.818,-8.83 9.818,-8.83 c 0,0 0.199,0.66 0.463,1.756 0.124,0.551 0.272,1.211 0.438,1.949 0.192,0.723 0.39,1.527 0.579,2.393 0.373,1.73 0.68,3.705 0.986,5.623 0.131,0.972 0.216,1.953 0.236,2.918 0.014,0.968 -0.029,1.916 -0.106,2.787 -0.377,3.521 -1.273,6.201 -2.597,7.675 C 8.5,17.748 6.738,18.01 4.778,16.838 0.72,14.574 -1.769,7.109 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1056"></path>
        </g>
        <g id="g1058" transform="matrix(1, 0, 0, 1, 103.877594, 405.462402)">
          <path d="m 0,0 c -2.958,-1.422 -6.152,-1.486 -8.713,-1.084 -2.539,0.387 -4.348,1.207 -4.348,1.207 0,0 0.264,0.637 0.748,1.641 0.504,1 1.296,2.345 2.243,3.779 0.914,1.443 2.188,2.902 3.505,4.184 1.3,1.291 2.841,2.322 4.398,2.912 1.554,0.59 2.971,0.906 4.232,1.002 C 3.337,13.73 4.477,13.582 5.409,13.285 7.298,12.672 8.37,11.492 8.646,9.848 8.922,8.195 8.111,6.541 6.684,4.803 5.956,3.945 4.975,3.131 3.864,2.314 2.77,1.492 1.475,0.709 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1060"></path>
        </g>
        <g id="g1062" transform="matrix(1, 0, 0, 1, 79.463989, 412.247498)">
          <path d="m 0,0 c 0.782,-1.611 1.941,-2.824 3.176,-3.74 1.234,-0.912 2.557,-1.533 3.769,-1.961 2.427,-0.854 4.408,-0.961 4.408,-0.961 0,0 0.059,0.685 0.092,1.814 0.054,1.125 0.15,2.676 0.123,4.446 -0.059,1.777 -0.031,3.718 -0.265,5.664 -0.253,1.955 -0.56,3.853 -1.198,5.504 C 9.463,12.42 8.748,13.826 7.986,14.953 7.235,16.08 6.467,16.92 5.64,17.461 4.021,18.545 2.153,18.406 0.639,16.867 -2.513,13.822 -3.337,6.451 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1064"></path>
        </g>
        <g id="g1066" transform="matrix(1, 0, 0, 1, 100.284271, 386.970215)">
          <path d="m 0,0 c -2.713,-1.912 -5.893,-2.432 -8.475,-2.404 -2.568,0.017 -4.476,0.57 -4.476,0.57 0,0 0.162,0.67 0.511,1.734 0.369,1.061 0.918,2.516 1.633,4.082 0.727,1.565 1.705,3.227 2.788,4.725 1.099,1.498 2.441,2.801 3.845,3.686 1.406,0.884 2.759,1.472 4.021,1.804 1.249,0.338 2.377,0.43 3.352,0.321 1.949,-0.225 3.298,-1.25 3.773,-2.856 C 8.024,8.391 5.306,3.877 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1068"></path>
        </g>
        <g id="g1070" transform="matrix(1, 0, 0, 1, 75.130096, 390.020996)">
          <path d="m 0,0 c 2.071,-2.889 5.195,-4.062 7.704,-4.564 2.524,-0.497 4.5,-0.321 4.5,-0.321 0,0 -0.048,0.69 -0.164,1.809 -0.094,1.117 -0.264,2.668 -0.563,4.406 C 11.188,3.066 10.855,4.984 10.293,6.85 9.747,8.715 9.112,10.516 8.157,12.008 7.203,13.502 6.251,14.729 5.327,15.676 4.39,16.625 3.448,17.293 2.535,17.666 0.712,18.41 -0.997,17.951 -2.278,16.24 -3.478,14.537 -4.032,11.914 -3.672,9 -3.483,7.543 -3.096,6.014 -2.505,4.488 -1.898,2.963 -1.038,1.445 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1072"></path>
        </g>
        <g id="g1074" transform="matrix(1, 0, 0, 1, 99.124695, 367.757324)">
          <path d="m 0,0 c -2.412,-2.256 -5.573,-3.133 -8.129,-3.406 -2.557,-0.28 -4.511,0.051 -4.511,0.051 0,0 0.099,0.685 0.324,1.783 0.212,1.097 0.59,2.607 1.133,4.252 1.066,3.293 2.902,7.095 5.499,9.242 C -0.48,16.207 4.09,15.889 5.469,12.75 6.924,9.559 4.862,4.523 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1076"></path>
        </g>
        <g id="g1078" transform="matrix(1, 0, 0, 1, 73.785797, 367.808105)">
          <path d="m 0,0 c 2.455,-2.586 5.63,-3.398 8.191,-3.604 2.561,-0.201 4.508,0.198 4.508,0.198 0,0 -0.111,0.679 -0.355,1.779 -0.255,1.098 -0.601,2.615 -1.087,4.303 C 10.266,6.047 8.833,10.107 6.589,12.789 4.305,15.465 2.167,17.076 0.234,17.545 -1.678,18.02 -3.301,17.342 -4.318,15.525 -6.298,11.908 -4.878,5.162 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1080"></path>
        </g>
        <g id="g1082" transform="matrix(1, 0, 0, 1, 93.343384, 333.278809)">
          <path d="m 0,0 c -0.221,0.004 -0.393,0.266 -0.381,0.578 0,0 0.045,1.471 0.252,4.029 0.21,2.559 0.583,6.207 1.285,10.551 1.388,8.666 4.125,20.18 9.056,30.869 2.443,5.34 5.446,10.436 8.82,14.803 3.343,4.393 7.105,7.986 10.622,10.649 0.437,0.339 0.864,0.673 1.281,0.998 0.427,0.31 0.871,0.576 1.29,0.857 0.843,0.549 1.644,1.07 2.398,1.559 1.573,0.863 2.959,1.595 4.099,2.195 2.374,1.006 3.73,1.582 3.73,1.582 0.289,0.125 0.588,0.053 0.666,-0.16 0.073,-0.201 -0.097,-0.463 -0.381,-0.586 0,0 -1.336,-0.567 -3.673,-1.555 C 37.942,75.777 36.58,75.055 35.029,74.209 34.289,73.727 33.501,73.213 32.67,72.67 32.258,72.398 31.821,72.135 31.4,71.828 30.989,71.51 30.569,71.182 30.139,70.848 26.675,68.225 22.966,64.684 19.664,60.344 16.331,56.029 13.358,50.988 10.937,45.695 6.048,35.1 3.323,23.648 1.943,15.031 1.245,10.715 0.874,7.084 0.665,4.543 0.459,2.002 0.416,0.549 0.416,0.549 0.403,0.238 0.219,-0.004 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1084"></path>
        </g>
        <g id="g1086" transform="matrix(1, 0, 0, 1, 129.002075, 397.030701)">
          <path d="m 0,0 c -2.257,0.529 -4.239,1.969 -5.591,3.314 -1.352,1.332 -2.084,2.612 -2.084,2.612 0,0 0.45,0.25 1.198,0.611 0.753,0.354 1.776,0.854 2.979,1.244 C -2.266,8.129 -0.9,8.428 0.421,8.549 1.783,8.604 3.125,8.436 4.243,8.02 4.805,7.811 5.312,7.576 5.769,7.326 6.232,7.062 6.654,6.758 7.021,6.461 7.756,5.857 8.295,5.221 8.658,4.592 9.381,3.33 9.427,2.098 8.831,1.184 8.284,0.152 7.188,-0.371 5.675,-0.518 4.225,-0.777 2.219,-0.461 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1088"></path>
        </g>
        <g id="g1090" transform="matrix(1, 0, 0, 1, 117.607086, 411.956512)">
          <path d="M 0,0 C -0.576,-2.732 0.417,-4.941 1.49,-6.506 2.576,-8.076 3.72,-9 3.72,-9 c 0,0 0.347,0.367 0.884,1.004 0.543,0.629 1.25,1.564 2.055,2.609 0.835,0.998 1.727,2.17 2.519,3.426 0.83,1.195 1.593,2.43 2.049,3.703 0.229,0.631 0.422,1.238 0.575,1.815 0.159,0.566 0.289,1.076 0.37,1.572 0.167,0.984 0.164,1.85 -0.016,2.555 C 11.799,9.102 10.711,9.893 8.978,9.82 7.301,9.643 5.307,8.619 3.611,6.904 1.983,5.088 0.525,2.783 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1092"></path>
        </g>
        <g id="g1094" transform="matrix(1, 0, 0, 1, 136.297974, 415.809998)">
          <path d="m 0,0 c -2.721,-0.623 -4.307,-2.449 -5.279,-4.08 -0.971,-1.649 -1.329,-3.07 -1.329,-3.07 0,0 0.48,-0.162 1.284,-0.381 0.798,-0.233 1.944,-0.479 3.228,-0.774 1.259,-0.338 2.695,-0.656 4.17,-0.847 1.431,-0.254 2.872,-0.428 4.218,-0.309 0.67,0.059 1.3,0.137 1.889,0.24 0.581,0.094 1.098,0.19 1.584,0.323 0.964,0.263 1.746,0.625 2.312,1.087 1.136,0.918 1.398,2.237 0.606,3.782 -0.863,1.447 -2.63,2.826 -4.9,3.646 C 5.453,0.334 2.75,0.691 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1096"></path>
        </g>
        <g id="g1098" transform="matrix(1, 0, 0, 1, 119.964996, 387.921417)">
          <path d="m 0,0 c -2.332,-0.168 -4.602,0.703 -6.249,1.656 -1.652,0.951 -2.68,1.998 -2.68,1.998 0,0 0.359,0.367 0.972,0.924 0.307,0.276 0.673,0.604 1.097,0.949 0.445,0.328 0.942,0.678 1.475,1.026 1.063,0.699 2.256,1.408 3.57,1.838 0.643,0.226 1.289,0.41 1.922,0.529 C 0.737,9.045 1.358,9.1 1.983,9.039 4.446,8.84 6.171,8.07 7.237,7.092 8.299,6.107 8.713,4.924 8.429,3.814 8.29,3.252 7.962,2.791 7.519,2.344 7.087,1.885 6.504,1.494 5.778,1.182 5.417,1.021 5.011,0.896 4.587,0.764 4.174,0.617 3.727,0.492 3.247,0.389 2.291,0.174 1.188,0.059 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1100"></path>
        </g>
        <g id="g1102" transform="matrix(1, 0, 0, 1, 105.030396, 399.300323)">
          <path d="m 0,0 c 0.238,-2.746 1.778,-4.633 3.218,-5.877 1.445,-1.24 2.788,-1.848 2.788,-1.848 0,0 0.23,0.455 0.567,1.221 0.163,0.387 0.357,0.848 0.574,1.365 0.235,0.502 0.485,1.063 0.735,1.67 0.499,1.211 0.982,2.612 1.456,3.971 0.222,0.689 0.412,1.396 0.554,2.096 0.137,0.705 0.229,1.4 0.287,2.047 0.185,2.617 -0.116,4.689 -0.89,5.937 -0.768,1.25 -2.018,1.672 -3.601,1.074 C 2.433,10.535 -0.36,5.414 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1104"></path>
        </g>
        <g id="g1106" transform="matrix(1, 0, 0, 1, 113.011383, 376.395996)">
          <path d="m 0,0 c -2.344,-0.65 -4.682,-0.279 -6.498,0.35 -1.8,0.615 -3.012,1.449 -3.012,1.449 0,0 0.275,0.43 0.76,1.099 0.499,0.663 1.252,1.541 2.13,2.461 0.855,0.934 1.975,1.832 3.104,2.594 C -2.398,8.727 -1.14,9.275 0.072,9.5 1.283,9.729 2.358,9.773 3.291,9.678 4.229,9.578 5.042,9.322 5.683,8.982 6.98,8.287 7.607,7.287 7.595,6.051 7.579,4.809 6.771,3.709 5.503,2.629 4.859,2.098 4.038,1.633 3.12,1.182 2.214,0.725 1.168,0.324 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1108"></path>
        </g>
        <g id="g1110" transform="matrix(1, 0, 0, 1, 96.092499, 384.538513)">
          <path d="m 0,0 c 0.359,-1.277 1.046,-2.314 1.826,-3.143 0.782,-0.828 1.665,-1.453 2.493,-1.923 1.66,-0.94 3.09,-1.278 3.09,-1.278 0,0 0.132,0.492 0.304,1.311 C 7.9,-4.219 8.172,-3.1 8.385,-1.807 8.574,-0.502 8.849,0.91 8.933,2.359 9.004,3.818 9.028,5.242 8.778,6.531 8.527,7.82 8.189,8.939 7.781,9.863 7.381,10.781 6.93,11.496 6.398,11.998 5.36,13 3.978,13.145 2.673,12.221 -0.024,10.41 -1.59,5.143 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1112"></path>
        </g>
        <g id="g1114" transform="matrix(1, 0, 0, 1, 107.970398, 363.378418)">
          <path d="m 0,0 c -2.229,-1.039 -4.617,-1.002 -6.495,-0.646 -1.872,0.351 -3.191,1.003 -3.191,1.003 0,0 0.206,0.467 0.599,1.198 0.408,0.724 0.999,1.715 1.727,2.763 0.734,1.047 1.665,2.131 2.651,3.082 0.997,0.95 2.146,1.721 3.287,2.186 1.14,0.461 2.204,0.713 3.168,0.789 0.955,0.082 1.789,0.004 2.486,-0.205 C 5.626,9.752 6.475,8.826 6.61,7.594 6.95,5.068 4.377,2.133 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1116"></path>
        </g>
        <g id="g1118" transform="matrix(1, 0, 0, 1, 90.023071, 368.895996)">
          <path d="m 0,0 c 1.133,-2.377 3.258,-3.645 5.021,-4.338 1.775,-0.691 3.24,-0.822 3.24,-0.822 0,0 0.056,0.508 0.118,1.34 0.077,0.826 0.156,1.982 0.165,3.287 C 8.562,0.771 8.569,2.213 8.403,3.648 8.249,5.08 8.021,6.477 7.52,7.691 7.021,8.904 6.486,9.924 5.936,10.736 5.377,11.551 4.777,12.162 4.16,12.553 2.929,13.332 1.621,13.223 0.463,12.141 -0.635,11.057 -1.382,9.217 -1.501,7.045 -1.554,5.957 -1.472,4.791 -1.24,3.602 -0.997,2.408 -0.568,1.189 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1120"></path>
        </g>
        <g id="g1122" transform="matrix(1, 0, 0, 1, 104.610474, 349.51712)">
          <path d="m 0,0 c -2.055,-1.33 -4.474,-1.555 -6.375,-1.42 -1.9,0.129 -3.283,0.627 -3.283,0.627 0,0 0.162,0.486 0.469,1.256 0.298,0.773 0.772,1.828 1.383,2.955 1.208,2.262 3.046,4.797 5.221,6.021 4.356,2.446 7.647,1.616 8.242,-0.855 C 6.3,6.066 4.138,2.662 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1124"></path>
        </g>
        <g id="g1126" transform="matrix(1, 0, 0, 1, 86.135895, 352.870605)">
          <path d="m 0,0 c 1.452,-2.209 3.662,-3.215 5.503,-3.701 1.841,-0.481 3.313,-0.445 3.313,-0.445 0,0 0.009,0.511 -0.025,1.341 C 8.748,-1.967 8.695,-0.816 8.561,0.477 8.279,3.066 7.766,6.215 6.479,8.465 5.164,10.715 3.814,12.17 2.466,12.764 1.134,13.361 -0.138,13.08 -1.118,11.889 -3.036,9.51 -2.882,4.402 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1128"></path>
        </g>
        <g id="g1130" transform="matrix(1, 0, 0, 1, 87.175476, 328.985809)">
          <path d="m 0,0 c 0.221,0.023 0.366,0.299 0.326,0.611 0,0 -0.183,1.459 -0.629,3.989 -0.449,2.525 -1.162,6.123 -2.269,10.38 -2.195,8.499 -6,19.706 -11.912,29.885 -2.933,5.09 -6.399,9.879 -10.168,13.91 -3.74,4.061 -7.823,7.286 -11.576,9.608 -0.465,0.299 -0.92,0.588 -1.368,0.873 -0.455,0.265 -0.921,0.492 -1.363,0.732 -0.892,0.467 -1.738,0.912 -2.535,1.326 -1.647,0.713 -3.094,1.311 -4.286,1.801 -2.458,0.78 -3.863,1.227 -3.863,1.227 -0.3,0.097 -0.589,-0.006 -0.647,-0.225 -0.055,-0.203 0.14,-0.447 0.434,-0.545 0,0 1.383,-0.439 3.802,-1.205 1.174,-0.486 2.596,-1.074 4.221,-1.769 0.781,-0.414 1.613,-0.85 2.493,-1.313 0.435,-0.232 0.894,-0.453 1.342,-0.719 0.439,-0.279 0.889,-0.566 1.348,-0.859 3.695,-2.285 7.72,-5.465 11.414,-9.477 3.723,-3.978 7.156,-8.722 10.063,-13.763 5.861,-10.09 9.647,-21.235 11.829,-29.684 1.099,-4.234 1.81,-7.814 2.257,-10.322 C -0.644,1.949 -0.465,0.508 -0.465,0.508 -0.424,0.201 -0.217,-0.025 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1132"></path>
        </g>
        <g id="g1134" transform="matrix(1, 0, 0, 1, 45.694977, 389.112823)">
          <path d="m 0,0 c 2.198,0.738 4.036,2.355 5.256,3.822 1.222,1.453 1.829,2.795 1.83,2.795 0,0 -0.472,0.207 -1.25,0.498 C 5.053,7.395 3.987,7.799 2.753,8.074 1.494,8.305 0.106,8.473 -1.221,8.469 -2.582,8.396 -3.901,8.102 -4.976,7.586 -5.516,7.324 -5.998,7.045 -6.429,6.75 -6.866,6.445 -7.259,6.104 -7.595,5.773 -8.27,5.102 -8.747,4.418 -9.051,3.76 -9.652,2.436 -9.582,1.205 -8.902,0.35 -8.261,-0.627 -7.121,-1.045 -5.601,-1.049 -4.133,-1.172 -2.166,-0.668 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1136"></path>
        </g>
        <g id="g1138" transform="matrix(1, 0, 0, 1, 55.640778, 405.038513)">
          <path d="m 0,0 c 0.829,-2.666 0.048,-4.955 -0.873,-6.615 -0.936,-1.666 -1.986,-2.694 -1.986,-2.694 0,0 -0.38,0.334 -0.976,0.916 -0.6,0.577 -1.391,1.444 -2.29,2.407 -0.925,0.918 -1.922,1.998 -2.83,3.175 -0.938,1.11 -1.814,2.268 -2.386,3.495 -0.287,0.605 -0.537,1.191 -0.743,1.754 -0.211,0.546 -0.389,1.042 -0.517,1.529 -0.257,0.965 -0.336,1.826 -0.222,2.545 0.223,1.443 1.231,2.332 2.963,2.426 C -8.174,8.92 -6.093,8.084 -4.244,6.535 -2.452,4.881 -0.784,2.725 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1140"></path>
        </g>
        <g id="g1142" transform="matrix(1, 0, 0, 1, 36.670578, 407.124512)">
          <path d="M 0,0 C 2.768,-0.367 4.518,-2.035 5.638,-3.57 6.759,-5.117 7.25,-6.5 7.25,-6.5 7.25,-6.5 6.787,-6.707 6.007,-7 5.235,-7.305 4.116,-7.66 2.865,-8.072 1.645,-8.527 0.244,-8.979 -1.207,-9.309 c -1.4,-0.384 -2.818,-0.693 -4.17,-0.701 -0.672,-0.006 -1.308,0.014 -1.903,0.063 -0.587,0.039 -1.111,0.084 -1.607,0.172 -0.985,0.171 -1.798,0.457 -2.405,0.869 -1.217,0.802 -1.601,2.094 -0.958,3.703 0.725,1.521 2.354,3.062 4.538,4.092 C -5.461,-0.178 -2.802,0.43 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1144"></path>
        </g>
        <g id="g1146" transform="matrix(1, 0, 0, 1, 55.547485, 380.890106)">
          <path d="m 0,0 c 2.337,0.053 4.514,1.129 6.066,2.234 1.555,1.102 2.48,2.241 2.48,2.241 0,0 -0.392,0.332 -1.054,0.828 C 7.161,5.549 6.766,5.844 6.311,6.146 5.837,6.43 5.31,6.732 4.747,7.029 3.622,7.623 2.368,8.219 1.02,8.523 0.358,8.688 -0.303,8.811 -0.944,8.871 -1.584,8.936 -2.207,8.932 -2.822,8.814 -5.256,8.383 -6.901,7.457 -7.87,6.379 -8.835,5.303 -9.137,4.084 -8.75,3.006 -8.559,2.459 -8.189,2.029 -7.707,1.629 -7.233,1.209 -6.615,0.877 -5.863,0.635 -5.489,0.51 -5.073,0.424 -4.639,0.33 -4.214,0.225 -3.757,0.141 -3.269,0.082 -2.297,-0.041 -1.189,-0.053 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1148"></path>
        </g>
        <g id="g1150" transform="matrix(1, 0, 0, 1, 69.348297, 393.620605)">
          <path d="m 0,0 c 0.021,-2.758 -1.335,-4.781 -2.652,-6.154 -1.322,-1.369 -2.602,-2.102 -2.602,-2.102 0,0 -0.272,0.432 -0.68,1.162 -0.197,0.369 -0.435,0.811 -0.7,1.305 -0.28,0.48 -0.581,1.012 -0.888,1.594 -0.61,1.16 -1.222,2.509 -1.821,3.818 -0.286,0.668 -0.541,1.352 -0.749,2.035 -0.202,0.688 -0.359,1.373 -0.477,2.01 -0.431,2.59 -0.324,4.682 0.329,5.996 0.647,1.316 1.852,1.852 3.484,1.406 C -3.41,10.26 -0.149,5.424 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1152"></path>
        </g>
        <g id="g1154" transform="matrix(1, 0, 0, 1, 63.550873, 370.06781)">
          <path d="M 0,0 C 2.396,-0.428 4.688,0.16 6.436,0.957 8.171,1.738 9.3,2.684 9.3,2.684 c 0,0 -0.316,0.4 -0.861,1.021 C 7.882,4.318 7.049,5.121 6.088,5.957 5.149,6.805 3.949,7.594 2.756,8.246 1.57,8.912 0.265,9.342 -0.963,9.451 -2.189,9.563 -3.264,9.51 -4.184,9.326 -5.109,9.139 -5.894,8.807 -6.5,8.408 -7.727,7.594 -8.257,6.541 -8.129,5.312 -7.997,4.078 -7.089,3.059 -5.726,2.1 -5.035,1.633 -4.173,1.246 -3.217,0.885 -2.272,0.514 -1.193,0.213 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1156"></path>
        </g>
        <g id="g1158" transform="matrix(1, 0, 0, 1, 79.63147, 379.7612)">
          <path d="m 0,0 c -0.237,-1.305 -0.824,-2.4 -1.523,-3.299 -0.701,-0.898 -1.522,-1.603 -2.302,-2.15 -1.564,-1.09 -2.956,-1.561 -2.956,-1.561 0,0 -0.179,0.477 -0.426,1.278 -0.263,0.791 -0.639,1.878 -0.971,3.148 -0.31,1.279 -0.717,2.658 -0.937,4.096 -0.207,1.445 -0.365,2.863 -0.237,4.166 0.129,1.308 0.36,2.455 0.681,3.41 0.311,0.953 0.693,1.705 1.176,2.256 0.939,1.095 2.302,1.369 3.688,0.57 C -0.952,10.365 1.101,5.268 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1160"></path>
        </g>
        <g id="g1162" transform="matrix(1, 0, 0, 1, 69.790192, 357.57962)">
          <path d="M 0,0 C 2.316,-0.824 4.691,-0.566 6.527,-0.031 8.357,0.492 9.61,1.266 9.61,1.266 9.61,1.266 9.361,1.709 8.902,2.4 8.427,3.084 7.747,4.014 6.923,4.988 6.094,5.963 5.065,6.955 3.996,7.811 2.912,8.66 1.696,9.324 0.518,9.676 -0.661,10.027 -1.744,10.18 -2.711,10.166 -3.669,10.158 -4.493,10.002 -5.167,9.729 -6.515,9.182 -7.273,8.18 -7.292,6.941 -7.395,4.395 -4.557,1.713 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1164"></path>
        </g>
        <g id="g1166" transform="matrix(1, 0, 0, 1, 87.141296, 364.75531)">
          <path d="m 0,0 c -0.905,-2.473 -2.901,-3.934 -4.593,-4.789 -1.703,-0.856 -3.148,-1.121 -3.148,-1.121 0,0 -0.103,0.5 -0.243,1.322 -0.154,0.815 -0.341,1.959 -0.473,3.256 -0.139,1.297 -0.282,2.732 -0.252,4.178 0.02,1.439 0.115,2.851 0.501,4.107 0.383,1.258 0.819,2.32 1.291,3.18 0.481,0.863 1.02,1.529 1.598,1.972 1.153,0.897 2.465,0.909 3.719,-0.058 C -0.405,11.07 0.511,9.309 0.833,7.154 0.988,6.078 1.016,4.908 0.896,3.701 0.767,2.494 0.455,1.238 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1168"></path>
        </g>
        <g id="g1170" transform="matrix(1, 0, 0, 1, 74.435669, 344.093201)">
          <path d="m 0,0 c 2.17,-1.127 4.601,-1.127 6.48,-0.814 1.88,0.306 3.21,0.933 3.21,0.933 0,0 -0.207,0.471 -0.586,1.205 C 8.735,2.068 8.164,3.07 7.45,4.135 6.036,6.275 3.97,8.625 1.688,9.643 -2.877,11.666 -6.076,10.531 -6.437,8.016 -6.841,5.449 -4.37,2.262 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1172"></path>
        </g>
        <g id="g1174" transform="matrix(1, 0, 0, 1, 92.514282, 349.165497)">
          <path d="m 0,0 c -1.238,-2.334 -3.344,-3.543 -5.131,-4.199 -1.788,-0.655 -3.258,-0.754 -3.258,-0.754 0,0 -0.056,0.508 -0.099,1.338 -0.037,0.836 -0.092,1.988 -0.08,3.289 0.039,2.603 0.254,5.785 1.323,8.146 1.099,2.366 2.306,3.94 3.594,4.659 1.268,0.718 2.562,0.556 3.649,-0.536 C 2.131,9.752 2.456,4.654 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1176"></path>
        </g>
        <g id="g1178" transform="matrix(1, 0, 0, 1, 87.813599, 357.075623)">
          <path d="m 0,0 c 0.22,-0.027 0.428,0.205 0.462,0.518 0,0 0.174,1.461 0.348,4.021 0.17,2.563 0.341,6.225 0.289,10.623 -0.091,8.777 -1.095,20.57 -4.391,31.871 -1.625,5.643 -3.84,11.127 -6.533,15.944 -2.655,4.839 -5.845,8.949 -8.929,12.105 -0.381,0.4 -0.755,0.791 -1.119,1.174 -0.377,0.369 -0.777,0.701 -1.148,1.039 -0.755,0.666 -1.47,1.303 -2.142,1.898 -1.429,1.084 -2.69,2.012 -3.73,2.776 -2.199,1.345 -3.456,2.117 -3.456,2.117 -0.267,0.166 -0.572,0.137 -0.68,-0.061 -0.104,-0.187 0.027,-0.47 0.289,-0.636 0,0 1.238,-0.756 3.402,-2.082 1.023,-0.75 2.264,-1.664 3.672,-2.731 0.66,-0.588 1.363,-1.213 2.106,-1.871 0.367,-0.33 0.759,-0.656 1.131,-1.021 0.358,-0.375 0.727,-0.76 1.101,-1.157 3.039,-3.105 6.183,-7.156 8.808,-11.937 2.657,-4.76 4.852,-10.186 6.463,-15.777 C -0.789,35.607 0.212,23.881 0.302,15.156 0.353,10.779 0.183,7.137 0.015,4.594 -0.158,2.049 -0.33,0.605 -0.33,0.605 -0.364,0.297 -0.217,0.031 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1180"></path>
        </g>
        <g id="g1182" transform="matrix(1, 0, 0, 1, 61.97818, 425.403809)">
          <path d="m 0,0 c 2.311,0.187 4.483,1.316 6.02,2.449 1.535,1.117 2.445,2.274 2.447,2.274 0,0 -0.408,0.314 -1.094,0.783 C 6.68,5.965 5.742,6.613 4.609,7.176 3.443,7.703 2.137,8.199 0.847,8.516 -0.491,8.771 -1.843,8.801 -3.01,8.559 -3.597,8.434 -4.133,8.275 -4.623,8.098 -5.118,7.904 -5.582,7.668 -5.988,7.426 -6.804,6.939 -7.43,6.389 -7.884,5.82 -8.786,4.682 -9.013,3.469 -8.558,2.475 -8.17,1.373 -7.164,0.695 -5.69,0.324 -4.293,-0.145 -2.263,-0.131 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1184"></path>
        </g>
        <g id="g1186" transform="matrix(1, 0, 0, 1, 75.455688, 438.476013)">
          <path d="m 0,0 c 0.165,-2.787 -1.145,-4.82 -2.435,-6.213 -1.309,-1.392 -2.576,-2.137 -2.576,-2.137 0,0 -0.288,0.416 -0.726,1.125 -0.444,0.702 -1.005,1.733 -1.646,2.885 -0.678,1.113 -1.387,2.401 -1.985,3.76 -0.645,1.303 -1.215,2.639 -1.478,3.967 -0.133,0.656 -0.235,1.283 -0.301,1.879 -0.074,0.584 -0.126,1.107 -0.134,1.611 -0.019,0.996 0.113,1.852 0.396,2.523 0.563,1.348 1.754,1.967 3.459,1.645 1.631,-0.424 3.451,-1.734 4.875,-3.682 C -1.209,5.328 -0.107,2.832 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1188"></path>
        </g>
        <g id="g1190" transform="matrix(1, 0, 0, 1, 57.539673, 445.054199)">
          <path d="m 0,0 c 2.6,-1.018 3.898,-3.061 4.617,-4.816 0.718,-1.772 0.861,-3.235 0.861,-3.235 0,0 -0.499,-0.09 -1.326,-0.187 -0.824,-0.11 -1.993,-0.186 -3.308,-0.285 -1.294,-0.151 -2.762,-0.252 -4.249,-0.223 -1.451,-0.037 -2.903,0.002 -4.217,0.318 -0.654,0.158 -1.266,0.33 -1.833,0.518 -0.559,0.18 -1.058,0.349 -1.517,0.553 -0.916,0.404 -1.636,0.878 -2.128,1.421 -0.988,1.073 -1.051,2.416 -0.04,3.827 1.068,1.304 3.02,2.408 5.387,2.882 C -5.344,1.139 -2.617,1.09 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1192"></path>
        </g>
        <g id="g1194" transform="matrix(1, 0, 0, 1, 69.567993, 415.056122)">
          <path d="m 0,0 c 2.281,-0.51 4.654,0.014 6.426,0.713 1.773,0.697 2.945,1.58 2.945,1.58 0,0 -0.301,0.414 -0.825,1.057 C 8.284,3.668 7.97,4.049 7.602,4.453 7.21,4.84 6.77,5.264 6.296,5.684 5.346,6.533 4.272,7.41 3.037,8.029 2.434,8.348 1.822,8.627 1.213,8.838 0.609,9.055 0.003,9.199 -0.624,9.232 -3.09,9.4 -4.909,8.895 -6.108,8.082 -7.303,7.268 -7.89,6.158 -7.772,5.018 -7.717,4.441 -7.463,3.938 -7.09,3.43 -6.731,2.912 -6.21,2.441 -5.539,2.023 -5.205,1.811 -4.822,1.629 -4.424,1.432 -4.038,1.229 -3.612,1.039 -3.153,0.865 -2.24,0.512 -1.167,0.232 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1196"></path>
        </g>
        <g id="g1198" transform="matrix(1, 0, 0, 1, 86.021698, 424.102997)">
          <path d="m 0,0 c -0.643,-2.684 -2.443,-4.322 -4.052,-5.338 -1.612,-1.014 -3.031,-1.416 -3.031,-1.416 0,0 -0.16,0.484 -0.38,1.291 -0.104,0.404 -0.227,0.891 -0.367,1.434 -0.157,0.535 -0.321,1.125 -0.479,1.761 -0.315,1.272 -0.584,2.729 -0.852,4.145 -0.118,0.715 -0.201,1.437 -0.237,2.152 -0.033,0.719 -0.019,1.422 0.018,2.069 0.203,2.615 0.808,4.621 1.758,5.74 0.945,1.123 2.244,1.353 3.721,0.529 C -0.848,10.777 1.157,5.301 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1200"></path>
        </g>
        <g id="g1202" transform="matrix(1, 0, 0, 1, 74.740387, 402.628418)">
          <path d="m 0,0 c 2.223,-0.99 4.589,-0.971 6.477,-0.615 1.872,0.342 3.194,0.988 3.194,0.988 0,0 -0.208,0.467 -0.588,1.199 C 8.688,2.301 8.072,3.281 7.34,4.322 6.632,5.371 5.657,6.426 4.654,7.346 3.663,8.275 2.498,9.006 1.333,9.408 0.17,9.811 -0.886,10.016 -1.824,10.059 -2.766,10.098 -3.608,9.967 -4.292,9.725 -5.678,9.229 -6.447,8.332 -6.617,7.109 -6.785,5.877 -6.147,4.672 -5.055,3.412 -4.496,2.795 -3.752,2.213 -2.911,1.633 -2.083,1.045 -1.107,0.494 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1204"></path>
        </g>
        <g id="g1206" transform="matrix(1, 0, 0, 1, 92.67688, 408.179199)">
          <path d="m 0,0 c -0.543,-1.211 -1.375,-2.135 -2.269,-2.838 -0.897,-0.703 -1.864,-1.189 -2.751,-1.533 -1.781,-0.684 -3.245,-0.807 -3.245,-0.807 0,0 -0.059,0.508 -0.107,1.342 -0.065,0.832 -0.169,1.979 -0.187,3.289 0.006,1.318 -0.057,2.754 0.074,4.201 0.145,1.453 0.332,2.867 0.769,4.104 0.44,1.236 0.941,2.293 1.48,3.146 0.53,0.852 1.084,1.491 1.684,1.91 1.175,0.834 2.563,0.774 3.717,-0.334 C 1.564,10.291 2.334,4.85 0,0" style="fill:#7c860a;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1208"></path>
        </g>
        <g id="g1210" transform="matrix(1, 0, 0, 1, 77.799469, 389.009216)">
          <path d="m 0,0 c 2.051,-1.359 4.419,-1.674 6.329,-1.6 1.903,0.069 3.304,0.522 3.304,0.522 0,0 -0.135,0.49 -0.415,1.271 C 8.922,0.971 8.484,2.035 7.919,3.182 7.348,4.324 6.587,5.537 5.753,6.623 4.906,7.707 3.885,8.643 2.825,9.268 1.766,9.895 0.75,10.299 -0.191,10.52 -1.124,10.742 -1.96,10.787 -2.68,10.684 -4.12,10.477 -5.097,9.686 -5.413,8.488 -6.123,6.041 -4.013,2.756 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1212"></path>
        </g>
        <g id="g1214" transform="matrix(1, 0, 0, 1, 96.365875, 391.809998)">
          <path d="m 0,0 c -1.472,-2.184 -3.761,-3.121 -5.607,-3.547 -1.858,-0.42 -3.326,-0.332 -3.326,-0.332 0,0 0.019,0.51 0.081,1.34 0.046,0.83 0.14,1.984 0.323,3.277 0.176,1.291 0.382,2.719 0.758,4.114 0.365,1.392 0.796,2.742 1.471,3.867 0.675,1.129 1.354,2.056 2.018,2.777 0.674,0.723 1.357,1.238 2.024,1.531 1.334,0.594 2.611,0.291 3.596,-0.947 C 2.263,10.844 2.73,8.912 2.527,6.746 2.417,5.662 2.165,4.521 1.759,3.379 1.343,2.236 0.739,1.092 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1216"></path>
        </g>
        <g id="g1218" transform="matrix(1, 0, 0, 1, 79.072388, 374.802216)">
          <path d="m 0,0 c 1.836,-1.617 4.196,-2.199 6.095,-2.346 1.899,-0.154 3.341,0.133 3.341,0.133 0,0 -0.089,0.506 -0.279,1.315 C 8.976,-0.09 8.663,1.021 8.225,2.225 7.366,4.643 5.924,7.42 3.953,8.955 0.007,12.016 -3.371,11.684 -4.325,9.326 -5.333,6.932 -3.699,3.244 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1220"></path>
        </g>
        <g id="g1222" transform="matrix(1, 0, 0, 1, 97.839996, 375.388123)">
          <path d="m 0,0 c -1.763,-1.971 -4.097,-2.639 -5.989,-2.848 -1.892,-0.205 -3.343,0.049 -3.343,0.049 0,0 0.066,0.506 0.223,1.326 0.166,0.819 0.389,1.952 0.713,3.209 0.663,2.52 1.636,5.559 3.24,7.592 1.634,2.031 3.184,3.272 4.605,3.658 1.405,0.395 2.622,-0.072 3.415,-1.394 C 4.409,8.953 3.502,3.928 0,0" style="fill:#99ba13;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1224"></path>
        </g>
        <g id="g1226" transform="matrix(1, 0, 0, 1, 138.958191, 357.024902)">
          <path d="m 0,0 c 0,4.861 -0.559,9.582 -1.605,14.086 h -99.962 c -1.047,-4.504 -1.605,-9.225 -1.605,-14.086 0,-23.162 12.639,-43.066 30.743,-51.871 v -7.918 h 41.684 v 7.918 C -12.639,-43.066 0,-23.162 0,0" style="fill:#754c29;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1228"></path>
        </g>
        <g id="g1230" transform="matrix(1, 0, 0, 1, -218.542816, 228.231903)">
          <g id="g1232"></g>
          <g id="g1244">
            <g clip-path="url(#clipPath1236)" opacity="0.100006" id="g1242">
              <g transform="translate(357.501,128.793)" id="g1240">
                <path d="m 0,0 c 0,4.861 -0.559,9.582 -1.605,14.086 h -27.291 c 1.508,-13.475 5.036,-73.369 -53.694,-59.385 3.131,-2.592 6.534,-4.806 10.161,-6.572 v -7.918 h 41.684 v 7.918 C -12.639,-43.066 0,-23.162 0,0" style="fill:#414042;fill-opacity:1;fill-rule:nonzero;stroke:none" id="path1238"></path>
              </g>
            </g>
          </g>
        </g>
      </g>
    </g>
  </g>
</svg></div></div>
<div class="text-neutral-500"><p>If you’ve made it this far, I invite you to view <a href="https://romgrk.com/castle">The Castle</a>.</p></div><!-- </CONTENT> --></div></div><div class="post-sidebar" data-astro-cid-xj2uyz6m=""><div class="post-sidebar-content" data-astro-cid-xj2uyz6m=""><a href="https://romgrk.com/posts/optimizing-javascript#0-avoid-work" data-astro-cid-xj2uyz6m="" class="active">0. Avoid work</a><a href="https://romgrk.com/posts/optimizing-javascript#1-avoid-string-comparisons" data-astro-cid-xj2uyz6m="" class="">1. Avoid string comparisons</a><a href="https://romgrk.com/posts/optimizing-javascript#2-avoid-different-shapes" data-astro-cid-xj2uyz6m="" class="">2. Avoid different shapes</a><a href="https://romgrk.com/posts/optimizing-javascript#3-avoid-arrayobject-methods" data-astro-cid-xj2uyz6m="" class="">3. Avoid array/object methods</a><a href="https://romgrk.com/posts/optimizing-javascript#4-avoid-indirection" data-astro-cid-xj2uyz6m="" class="">4. Avoid indirection</a><a href="https://romgrk.com/posts/optimizing-javascript#5-avoid-cache-misses" data-astro-cid-xj2uyz6m="" class="">5. Avoid cache misses</a><a href="https://romgrk.com/posts/optimizing-javascript#6-avoid-large-objects" data-astro-cid-xj2uyz6m="" class="">6. Avoid large objects</a><a href="https://romgrk.com/posts/optimizing-javascript#7-use-eval" data-astro-cid-xj2uyz6m="" class="">7. Use eval</a><a href="https://romgrk.com/posts/optimizing-javascript#8-use-strings-carefully" data-astro-cid-xj2uyz6m="" class="">8. Use strings, carefully</a><a href="https://romgrk.com/posts/optimizing-javascript#9-use-specialization" data-astro-cid-xj2uyz6m="" class="">9. Use specialization</a><a href="https://romgrk.com/posts/optimizing-javascript#10-data-structures" data-astro-cid-xj2uyz6m="" class="">10. Data structures</a><a href="https://romgrk.com/posts/optimizing-javascript#11-benchmarking" data-astro-cid-xj2uyz6m="" class="">11. Benchmarking</a><a href="https://romgrk.com/posts/optimizing-javascript#12-profiling--tools" data-astro-cid-xj2uyz6m="" class="">12. Profiling &amp; tools</a><a href="https://romgrk.com/posts/optimizing-javascript#final-notes" data-astro-cid-xj2uyz6m="" class="">Final notes</a></div></div></article></main><footer class="footer" data-astro-cid-sz7xmlte=""><div class="footer-links" data-astro-cid-sz7xmlte=""><a href="mailto:romgrk.cc@gmail.com" data-astro-cid-sz7xmlte="">Comments?</a><a href="https://github.com/romgrk" target="_blank" class="footer-github" data-astro-cid-sz7xmlte=""><span class="fa fa-github" data-astro-cid-sz7xmlte=""></span><span class="sr-only" data-astro-cid-sz7xmlte="">Github</span></a></div><div class="footer-dedication" data-astro-cid-sz7xmlte=""><div data-astro-cid-sz7xmlte="">I dedicate this blog and anyone who reads this sentence to the public domain.</div><div data-astro-cid-sz7xmlte="">What do you mean that's not how licensing works?</div></div></footer><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'8c331f40097e56b5',t:'MTcyNjM0NTY5Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><iframe height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" src="./Optimizing Javascript for fun and for profit_files/saved_resource.html"></iframe></body></html>